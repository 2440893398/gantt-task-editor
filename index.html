<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>甘特图任务编辑页面 - 模块化版本</title>
    <meta name="description" content="甘特图任务编辑器，支持自定义字段、批量编辑等功能">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- DHTMLX Gantt -->
    <link href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css" rel="stylesheet">
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <script src="https://docs.dhtmlx.com/gantt/codebase/locale/locale_cn.js"></script>

    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body>
    <!-- 应用主容器 - 工具栏与甘特图统一 -->
    <div id="app-container" class="app-container">
        <!-- 工具栏 - 绝对定位在甘特图时间轴区域 -->
        <div id="field-toolbar" class="toolbar-redesign">
            <!-- 左侧区域 (占位) -->
            <div class="toolbar-left"></div>

            <!-- 中间区域：搜索框 -->
            <div class="toolbar-center">
                <div class="search-container">
                    <span class="search-icon">🔍</span>
                    <input type="text" class="search-input" id="task-search-input" placeholder="Search tasks..."
                        data-i18n-placeholder="toolbar.searchPlaceholder">
                </div>
            </div>

            <!-- 右侧区域：今日按钮 + 图标按钮组 + More + New Task -->
            <div class="toolbar-right">
                <!-- 今日按钮 -->
                <button class="today-btn-enhanced" id="scroll-to-today-btn" data-i18n="toolbar.today">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                        <circle cx="12" cy="16" r="2" fill="currentColor" />
                    </svg>
                    <span data-i18n="toolbar.today">今天</span>
                </button>

                <!-- 分隔线 -->
                <div class="toolbar-divider"></div>

                <!-- 图标按钮组 -->
                <div class="icon-btn-group">
                    <button class="icon-btn" id="add-field-btn" title="编辑字段" data-i18n-title="toolbar.editFields">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7" />
                            <line x1="12" y1="8" x2="12" y2="16" />
                            <line x1="8" y1="12" x2="16" y2="12" />
                        </svg>
                    </button>
                    <button class="icon-btn" id="batch-edit-btn" title="批量编辑" data-testid="batch-edit-btn"
                        data-i18n-title="toolbar.batchEdit">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                        </svg>
                    </button>
                    <button class="icon-btn" id="config-export-btn" title="导出" data-testid="config-export-btn"
                        data-i18n-title="toolbar.export">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                    </button>
                </div>

                <!-- 分隔线 -->
                <div class="toolbar-divider"></div>

                <!-- 更多操作下拉菜单 -->
                <div class="toolbar-dropdown" id="more-actions-dropdown">
                    <button class="more-btn">
                        <span data-i18n="toolbar.more">More</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="dropdown-menu">
                        <!-- 导入导出 -->
                        <div class="dropdown-item" id="dropdown-export-excel">
                            <span class="dropdown-item-icon">📊</span>
                            <span data-i18n="toolbar.exportExcel">导出Excel</span>
                        </div>
                        <div class="dropdown-item" id="dropdown-import-excel">
                            <span class="dropdown-item-icon">📥</span>
                            <span data-i18n="toolbar.importExcel">导入Excel</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" id="dropdown-export-json">
                            <span class="dropdown-item-icon">📤</span>
                            <span data-i18n="toolbar.exportJSON">导出JSON</span>
                        </div>
                        <div class="dropdown-item" id="dropdown-import-json">
                            <span class="dropdown-item-icon">📂</span>
                            <span data-i18n="toolbar.importJSON">导入JSON</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <!-- 关键路径开关 -->
                        <div class="dropdown-item" id="toggle-critical-path">
                            <span class="dropdown-item-icon">🔥</span>
                            <span data-i18n="toolbar.criticalPath">关键路径</span>
                            <span class="toggle-indicator" id="cpm-indicator"
                                style="margin-left: auto; font-size: 12px; color: #9CA3AF;">○</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <!-- 语言选择 -->
                        <div class="dropdown-item dropdown-submenu" id="language-menu">
                            <span class="dropdown-item-icon">🌐</span>
                            <span data-i18n="toolbar.language">语言</span>
                            <span class="submenu-arrow">›</span>
                            <div class="submenu">
                                <div class="dropdown-item" data-lang="zh-CN">简体中文</div>
                                <div class="dropdown-item" data-lang="en-US">English</div>
                                <div class="dropdown-item" data-lang="ja-JP">日本語</div>
                                <div class="dropdown-item" data-lang="ko-KR">한국어</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 新建任务按钮 -->
                <button class="new-task-btn" id="new-task-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span data-i18n="toolbar.newTask">New Task</span>
                </button>
            </div>
        </div>

        <!-- 甘特图容器 - 全高度 -->
        <div id="gantt_here"></div>
    </div>

    <!-- 快捷键和图例面板 - 默认折叠 -->
    <div class="shortcuts-panel collapsed" id="shortcuts-panel">
        <div class="shortcuts-header" id="shortcuts-header">
            <div class="shortcuts-title">
                <span>⌨️</span>
                <span data-i18n="shortcuts.title">快捷键 & 图例</span>
            </div>
            <span class="shortcuts-toggle">▼</span>
        </div>
        <div class="shortcuts-content">
            <!-- 导航快捷键 -->
            <div class="shortcuts-section">
                <div class="shortcuts-section-title" data-i18n="shortcuts.navigation">导航</div>
                <div class="shortcut-item">
                    <span class="shortcut-action" data-i18n="shortcuts.panView">平移视图</span>
                    <div class="shortcut-keys">
                        <span class="key">Space</span>
                        <span style="color: #9CA3AF;">+</span>
                        <span class="key" data-i18n="shortcuts.drag">拖动</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-action" data-i18n="shortcuts.zoomTimeline">缩放时间轴</span>
                    <div class="shortcut-keys">
                        <span class="key">Ctrl</span>
                        <span style="color: #9CA3AF;">+</span>
                        <span class="key" data-i18n="shortcuts.scroll">滚轮</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-action" data-i18n="shortcuts.goToToday">回到今天</span>
                    <div class="shortcut-keys">
                        <span class="key" data-i18n="shortcuts.clickToday">点击"今天"按钮</span>
                    </div>
                </div>
            </div>

            <!-- 任务操作 -->
            <div class="shortcuts-section">
                <div class="shortcuts-section-title" data-i18n="shortcuts.taskOperations">任务操作</div>
                <div class="shortcut-item">
                    <span class="shortcut-action" data-i18n="shortcuts.editTask">编辑任务</span>
                    <div class="shortcut-keys">
                        <span class="key" data-i18n="shortcuts.doubleClick">双击</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-action" data-i18n="shortcuts.adjustTime">调整时间</span>
                    <div class="shortcut-keys">
                        <span class="key" data-i18n="shortcuts.dragTask">拖动任务条</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-action" data-i18n="shortcuts.adjustProgress">调整进度</span>
                    <div class="shortcut-keys">
                        <span class="key" data-i18n="shortcuts.dragProgress">拖动进度条</span>
                    </div>
                </div>
            </div>

            <!-- 图例 -->
            <div class="shortcuts-section legend-section">
                <div class="shortcuts-section-title" data-i18n="shortcuts.legend">图例</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-color completed"></span>
                        <span data-i18n="shortcuts.completed">已完成</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color incomplete"></span>
                        <span data-i18n="shortcuts.incomplete">未完成</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color dependency"></span>
                        <span data-i18n="shortcuts.dependency">依赖关系</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 折叠/展开快捷键面板
        document.addEventListener('DOMContentLoaded', () => {
            const panel = document.getElementById('shortcuts-panel');
            const header = document.getElementById('shortcuts-header');

            header.addEventListener('click', () => {
                panel.classList.toggle('collapsed');
            });
        });
    </script>

    <!-- 缩放控件 -->
    <div id="zoom-controls" class="zoom-controls">
        <button id="zoom-out-btn" class="zoom-btn" title="缩小时间跨度" data-i18n-title="view.zoomOut">－</button>
        <input type="range" id="zoom-slider" min="0" max="4" value="1" class="zoom-slider">
        <button id="zoom-in-btn" class="zoom-btn" title="扩大时间跨度" data-i18n-title="view.zoomIn">＋</button>
        <div class="zoom-divider"></div>
        <select id="view-selector" class="zoom-view-selector" data-testid="view-selector">
            <option value="day" data-i18n="view.day">日视图</option>
            <option value="week" selected data-i18n="view.week">周视图</option>
            <option value="month" data-i18n="view.month">月视图</option>
            <option value="quarter" data-i18n="view.quarter">季度视图</option>
            <option value="year" data-i18n="view.year">年视图</option>
        </select>
    </div>

    <script>
        // 工具栏下拉菜单逻辑
        document.addEventListener('DOMContentLoaded', () => {
            const dropdown = document.getElementById('more-actions-dropdown');
            const moreBtn = dropdown.querySelector('.more-btn');

            // 切换更多下拉菜单
            moreBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('active');
            });

            // 点击外部关闭
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });

            // 语言选择
            document.querySelectorAll('#language-menu .submenu .dropdown-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const lang = item.dataset.lang;
                    if (lang && window.i18n) {
                        window.i18n.setLanguage(lang);
                    }
                    dropdown.classList.remove('active');
                });
            });

            // 新建任务按钮
            document.getElementById('new-task-btn')?.addEventListener('click', () => {
                gantt.createTask({
                    text: '',
                    start_date: new Date(),
                    duration: 1
                });
            });

            // 日期导航
            document.getElementById('nav-prev-btn')?.addEventListener('click', () => {
                const state = gantt.getState();
                const unit = state.scale_mode === 'day' ? 'day' :
                    state.scale_mode === 'week' ? 'week' :
                        state.scale_mode === 'month' ? 'month' : 'quarter';
                const newDate = gantt.date.add(state.min_date, -1, unit);
                gantt.scrollTo(newDate);
            });

            document.getElementById('nav-next-btn')?.addEventListener('click', () => {
                const state = gantt.getState();
                const unit = state.scale_mode === 'day' ? 'day' :
                    state.scale_mode === 'week' ? 'week' :
                        state.scale_mode === 'month' ? 'month' : 'quarter';
                const newDate = gantt.date.add(state.min_date, 1, unit);
                gantt.scrollTo(newDate);
            });

            // 任务搜索
            const searchInput = document.getElementById('task-search-input');
            searchInput?.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                gantt.eachTask(task => {
                    const matches = !query || task.text.toLowerCase().includes(query);
                    const el = gantt.getTaskRowNode(task.id);
                    if (el) {
                        el.style.display = matches ? '' : 'none';
                    }
                });
            });

            // 导入JSON
            document.getElementById('dropdown-import-json')?.addEventListener('click', () => {
                dropdown.classList.remove('active');
                document.getElementById('config-import-btn')?.click();
            });

            // 导出JSON (兼容旧ID)  
            document.getElementById('dropdown-export-json')?.addEventListener('click', () => {
                dropdown.classList.remove('active');
                // 触发原有的导出功能
                if (window.exportConfig) {
                    window.exportConfig();
                }
            });
        });
    </script>

    <!-- 选中任务计数器 -->
    <div id="selected-tasks-counter">
        <span style="color: #0C4A6E; font-size: 14px; font-weight: 500;" id="selected-count-text"
            data-i18n="batchEdit.selectedCount" data-i18n-params='{"count":0}'>
            已选中 0 个任务
        </span>
        <button id="clear-selection-btn" class="btn-secondary" style="padding: 4px 12px; font-size: 12px;"
            data-i18n="batchEdit.clear">清除选择</button>
    </div>

    <!-- 批量编辑面板 -->
    <div id="batch-edit-panel">
        <div class="batch-edit-header">
            <h3 data-i18n="batchEdit.title">批量编辑</h3>
            <button id="close-batch-edit"
                style="background: none; border: none; font-size: 24px; color: #6B7280; cursor: pointer;">&times;</button>
        </div>
        <div class="batch-edit-body">
            <div style="background: #E0F2FE; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                <span style="color: #0C4A6E; font-size: 14px; font-weight: 500;">
                    <span id="batch-selected-count-text" data-i18n="batchEdit.selectedCount"
                        data-i18n-params='{"count":0}'>ℹ️ 已选中 0 个任务</span>
                </span>
            </div>
            <div class="form-group">
                <label data-i18n="batchEdit.selectField">选择要修改的字段</label>
                <select id="batch-field-select" class="form-control">
                    <option value="" data-i18n="form.selectPlaceholder">请选择字段</option>
                </select>
            </div>
            <div id="batch-field-input-container" style="display: none;">
                <div class="form-group">
                    <label id="batch-field-label" data-i18n="batchEdit.fieldValue">字段值</label>
                    <div id="batch-field-input"></div>
                </div>
            </div>
        </div>
        <div class="batch-edit-footer">
            <button id="batch-cancel-btn" class="btn-secondary" data-i18n="form.cancel">取消</button>
            <button id="batch-apply-btn" class="btn-primary" data-i18n="batchEdit.apply">应用到所有任务</button>
        </div>
    </div>

    <!-- 字段管理面板 -->
    <div id="field-management-panel">
        <div class="field-management-header">
            <h4 style="margin: 0; font-size: 14px; font-weight: 600;" data-i18n="fieldManagement.title">字段管理</h4>
            <button id="close-field-management"
                style="background: none; border: none; font-size: 24px; color: #6B7280; cursor: pointer;">&times;</button>
        </div>
        <div class="field-management-body" id="field-list-container">
            <!-- 字段列表将在这里动态生成 -->
        </div>
        <div style="padding: 16px; background: white; border-top: 1px solid var(--border-color);">
            <button id="add-field-from-panel-btn" class="btn-secondary" style="width: 100%;"
                data-i18n="fieldManagement.addField">+ 新增字段</button>
        </div>
    </div>

    <!-- 字段配置弹窗 -->
    <div id="field-config-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <!-- 渐变头部 -->
            <div class="modal-header-gradient">
                <div class="modal-header-icon">✦</div>
                <div class="modal-header-text">
                    <h3 data-i18n="fieldManagement.title">字段配置</h3>
                    <p data-i18n="fieldManagement.createSubtitle">创建和自定义您的字段</p>
                </div>
                <button class="modal-close-btn" id="modal-close-x">×</button>
            </div>

            <!-- 内容区域 -->
            <div class="modal-body">
                <!-- 字段名称 -->
                <div class="form-group">
                    <label><span class="label-icon">T</span> <span
                            data-i18n="fieldManagement.fieldName">字段名称</span></label>
                    <input type="text" id="field-name" data-testid="field-name-input" class="form-control"
                        placeholder="请输入字段名称" data-i18n-placeholder="fieldManagement.placeholderName">
                </div>

                <!-- 字段类型 -->
                <div class="form-group" style="position: relative;">
                    <label><span class="label-icon">≡</span> <span
                            data-i18n="fieldManagement.fieldType">字段类型</span></label>
                    <div class="field-type-selector" id="field-type-selector">
                        <span class="field-type-icon icon-number">#</span>
                        <span class="field-type-text" data-i18n="fieldManagement.typeNumber">数字</span>
                        <span style="margin-left: auto; color: #9CA3AF;">▼</span>
                    </div>
                    <select id="field-type" style="display: none;">
                        <option value="text">文本</option>
                        <option value="number" selected>数字</option>
                        <option value="date">日期</option>
                        <option value="select">下拉选择</option>
                        <option value="multiselect">多选</option>
                    </select>
                    <div class="field-type-dropdown" id="field-type-dropdown">
                        <div class="field-type-option" data-value="text">
                            <span class="field-type-icon icon-text">Ā</span>
                            <span data-i18n="fieldManagement.typeText">文本</span>
                        </div>
                        <div class="field-type-option selected" data-value="number">
                            <span class="field-type-icon icon-number">#</span>
                            <span data-i18n="fieldManagement.typeNumber">数字</span>
                            <span class="check-icon">✓</span>
                        </div>
                        <div class="field-type-option" data-value="date">
                            <span class="field-type-icon icon-date">☐</span>
                            <span data-i18n="fieldManagement.typeDate">日期</span>
                        </div>
                        <div class="field-type-option" data-value="select">
                            <span class="field-type-icon icon-select">˅</span>
                            <span data-i18n="fieldManagement.typeSelect">下拉选择</span>
                        </div>
                        <div class="field-type-option" data-value="multiselect">
                            <span class="field-type-icon icon-multiselect">≡</span>
                            <span data-i18n="fieldManagement.typeMultiselect">多选</span>
                        </div>
                    </div>
                </div>

                <!-- 必填字段 -->
                <div class="required-field-row" id="required-field-row">
                    <div class="required-toggle" id="required-toggle"></div>
                    <div class="required-field-info">
                        <div class="title" data-i18n="fieldManagement.required">必填字段</div>
                        <div class="subtitle" data-i18n="fieldManagement.requiredDesc">用户必须填写此字段</div>
                    </div>
                    <span class="required-field-arrow">›</span>
                    <input type="checkbox" id="field-required" style="display: none;">
                </div>

                <!-- 默认值信息卡片 -->
                <div class="default-value-card">
                    <div class="default-value-header">
                        <div class="default-value-icon">ⓘ</div>
                        <div class="default-value-text">
                            <h4 data-i18n="fieldManagement.defaultOneTime">默认值 (可选)</h4>
                            <p data-i18n="fieldManagement.defaultDesc">现有任务将自动填充此值</p>
                        </div>
                    </div>
                    <input type="text" id="field-default-value" class="form-control" placeholder="输入默认值..."
                        data-i18n-placeholder="fieldManagement.defaultPlaceholder" style="margin-bottom: 12px;">
                    <div class="default-value-note" data-i18n="fieldManagement.defaultNote">新增字段时，所有现有任务将被设置为此默认值。</div>
                </div>

                <!-- 选项配置 -->
                <div id="options-config" class="form-group" style="display: none;">
                    <label><span class="label-icon">☰</span> <span
                            data-i18n="fieldManagement.options">选项配置</span></label>
                    <div id="options-list"></div>
                    <button id="add-option-btn" class="btn-secondary"
                        style="margin-top: 8px; padding: 8px 14px; font-size: 13px;"
                        data-i18n="fieldManagement.addOption">+ 添加选项</button>
                </div>
            </div>

            <!-- 底部按钮 -->
            <div class="modal-footer">
                <button id="cancel-field-btn" class="btn-secondary" data-i18n="form.cancel">取消</button>
                <button id="save-field-btn" data-testid="save-field-btn" class="btn-primary"
                    data-i18n="form.save">保存</button>
            </div>
        </div>
    </div>

    <!-- 文件输入(用于导入配置) -->
    <input type="file" id="config-file-input" style="display: none;" accept=".json">

    <!-- 入口 JS -->
    <script type="module" src="/src/main.js"></script>
</body>

</html>