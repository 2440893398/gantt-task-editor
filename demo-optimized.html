<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ç”˜ç‰¹å›¾ä»»åŠ¡ç¼–è¾‘é¡µé¢ä¼˜åŒ– - å®Œæ•´å®ç°</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <link href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css" rel="stylesheet">

    <style>
        /* 1. è®¾è®¡ç³»ç»Ÿå˜é‡ */
        :root {
            /* è‰²å½©ç³»ç»Ÿ */
            --primary-color: #4A90E2;
            --accent-color: #50E3C2;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --background-gray: #F9FAFB;
            --background-hover-gray: #F3F4F6;
            --background-white: #FFFFFF;
            --color-success: #22C55E;
            --color-warning: #F59E0B;
            --color-error: #EF4444;
            --task-bar-bg: #A5C8F1;

            /* å­—ä½“è§„èŒƒ */
            --font-family-base: 'Inter', 'Source Han Sans CN', sans-serif;
            --font-size-body: 14px;
            --font-size-small: 12px;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;

            /* å¸ƒå±€ç³»ç»Ÿ */
            --border-radius-small: 4px;
            --border-radius-medium: 8px;
            --shadow-standard: 0px 4px 6px -1px rgba(0, 0, 0, 0.1), 0px 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* 2. å…¨å±€æ ·å¼ */
        html,
        body {
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
            font-family: var(--font-family-base);
            color: var(--text-primary);
            background-color: var(--background-gray);
        }

        #gantt_here {
            width: 100%;
            height: 100%;
        }

        /* 3. ç”˜ç‰¹å›¾ç»„ä»¶æ ·å¼ */
        .gantt_container {
            border: none;
        }

        .gantt_grid,
        .gantt_task {
            border-top: 1px solid var(--border-color);
        }

        .gantt_grid_scale,
        .gantt_task_scale {
            background-color: var(--background-white);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        /* è¡¨æ ¼åŒºåŸŸ */
        .gantt_grid_head_cell {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-body);
            color: var(--text-primary);
            cursor: move;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .gantt_grid_head_cell:hover {
            background-color: #F3F4F6;
            transform: translateY(-1px);
        }

        .gantt_row {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }

        .gantt_row:hover {
            background-color: var(--background-hover-gray);
        }

        .gantt_row.odd {
            background-color: var(--background-white);
        }

        .gantt_grid_data .gantt_cell {
            font-size: var(--font-size-body);
            font-weight: var(--font-weight-regular);
        }

        .gantt_tree_content {
            font-weight: var(--font-weight-medium);
        }

        .gantt_grid_data {
            background-color: var(--background-white);
        }

        /* æ—¶é—´è½´ */
        .gantt_task_scale .gantt_scale_cell {
            font-size: var(--font-size-small);
            font-weight: var(--font-weight-regular);
        }

        .gantt_data_area {
            background-color: var(--background-white);
        }

        .gantt_task_row {
            border-bottom: 1px solid var(--border-color);
        }

        .gantt_task_row.odd {
            background-color: var(--background-white);
        }

        .weekend {
            background-color: var(--background-gray) !important;
        }

        /* ä»»åŠ¡æ¡ */
        .gantt_task_line {
            background-color: var(--task-bar-bg);
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius-small);
        }

        .gantt_task_line:hover {
            box-shadow: var(--shadow-standard);
        }

        .gantt_task_progress {
            background-color: var(--accent-color);
            border-radius: var(--border-radius-small);
        }

        .gantt_task_line.task_overdue {
            background-color: var(--color-error);
            border-color: var(--color-error);
        }

        /* ä¾èµ–è¿çº¿ */
        .gantt_link_line {
            stroke: var(--primary-color);
            stroke-width: 1;
        }

        .gantt_link_arrow_right {
            border-left-color: var(--primary-color);
        }

        /* 4. P0åŠŸèƒ½: åŠ¨æ€é«˜åº¦è‡ªå®šä¹‰å­—æ®µæ ·å¼ */
        .fields-grid.two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .fields-grid.scrollable {
            overflow-y: auto;
            padding-right: 8px;
        }

        .fields-grid.scrollable::-webkit-scrollbar {
            width: 8px;
        }

        .fields-grid.scrollable::-webkit-scrollbar-track {
            background: #E5E7EB;
            border-radius: 4px;
        }

        .fields-grid.scrollable::-webkit-scrollbar {
            width: 8px;
        }

        /* 12. P1åŠŸèƒ½: é€šç”¨æ»šåŠ¨æ¡æ ·å¼ä¼˜åŒ– */
        .gantt_cal_ltext::-webkit-scrollbar,
        .gantt_custom_fields_container::-webkit-scrollbar,
        .batch-edit-body::-webkit-scrollbar,
        .field-management-body::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .gantt_cal_ltext::-webkit-scrollbar-track,
        .gantt_custom_fields_container::-webkit-scrollbar-track,
        .batch-edit-body::-webkit-scrollbar-track,
        .field-management-body::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track,
        .fields-grid.scrollable::-webkit-scrollbar-track {
            background: #E5E7EB;
            border-radius: 4px;
        }

        .gantt_cal_ltext::-webkit-scrollbar-thumb,
        .gantt_custom_fields_container::-webkit-scrollbar-thumb,
        .batch-edit-body::-webkit-scrollbar-thumb,
        .field-management-body::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb,
        .fields-grid.scrollable::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 4px;
        }

        .gantt_cal_ltext::-webkit-scrollbar-thumb:hover,
        .gantt_custom_fields_container::-webkit-scrollbar-thumb:hover,
        .batch-edit-body::-webkit-scrollbar-thumb:hover,
        .field-management-body::-webkit-scrollbar-thumb:hover,
        .modal-content::-webkit-scrollbar-thumb:hover,
        .fields-grid.scrollable::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        /* 5. P1åŠŸèƒ½: æ‰¹é‡ç¼–è¾‘é¢æ¿æ ·å¼ */
        #batch-edit-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            max-width: 100%;
            height: 100vh;
            background: white;
            box-shadow: -4px 0px 12px rgba(0, 0, 0, 0.1);
            z-index: 5000;
            transition: right 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        #batch-edit-panel.open {
            right: 0;
        }

        @media (max-width: 768px) {
            #batch-edit-panel {
                width: 100%;
                right: -100%;
            }
        }

        .batch-edit-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .batch-edit-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .batch-edit-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .batch-edit-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            background: var(--background-gray);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* 6. P1åŠŸèƒ½: å­—æ®µç®¡ç†é¢æ¿æ ·å¼ */
        #field-management-panel {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            max-width: 100%;
            height: 100vh;
            background: var(--background-gray);
            box-shadow: -4px 0px 12px rgba(0, 0, 0, 0.1);
            z-index: 6000;
            transition: right 0.25s ease-out;
            display: flex;
            flex-direction: column;
        }

        #field-management-panel.open {
            right: 0;
        }

        @media (max-width: 768px) {
            #field-management-panel {
                width: 100%;
                right: -100%;
            }
        }

        .field-management-header {
            padding: 16px 20px;
            background: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .field-management-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .field-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: move;
            transition: all 0.2s ease;
        }

        .field-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .field-drag-handle {
            color: #9CA3AF;
            font-size: 16px;
            cursor: grab;
        }

        .field-info {
            flex: 1;
        }

        .field-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .field-type-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #E5E7EB;
            border-radius: 4px;
            font-size: 12px;
            color: #6B7280;
            margin-top: 4px;
        }

        .field-actions {
            display: flex;
            gap: 8px;
        }

        .field-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            transition: transform 0.2s;
        }

        .field-action-btn:hover {
            transform: scale(1.2);
        }

        /* 7. é€šç”¨æŒ‰é’®æ ·å¼ */
        .btn-primary {
            padding: 10px 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #3A7BC8;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            padding: 10px 24px;
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: var(--background-hover-gray);
        }

        .btn-danger {
            padding: 10px 20px;
            background: white;
            color: var(--color-error);
            border: 1px solid var(--color-error);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-danger:hover {
            background: #FEF2F2;
        }

        /* 8. å·¥å…·æ æ ·å¼ */
        #field-toolbar {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 8px;
        }

        #field-toolbar button {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        #field-toolbar button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* 9. å­—æ®µé…ç½®å¼¹çª—æ ·å¼ */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-backdrop.show {
            opacity: 1;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-backdrop.show .modal-content {
            transform: scale(1);
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 13px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            border-width: 2px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* 10. é€‰ä¸­ä»»åŠ¡è®¡æ•°å™¨ */
        #selected-tasks-counter {
            position: fixed;
            top: 70px;
            right: 10px;
            z-index: 1000;
            background: #E0F2FE;
            padding: 10px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
            align-items: center;
            gap: 12px;
        }

        #selected-tasks-counter.show {
            display: flex;
        }

        /* 11. P0åŠŸèƒ½: è‡ªå®šä¹‰Lightboxæ ·å¼å¢å¼º */
        .gantt_cal_light {
            border-radius: 12px;
            box-shadow: 0px 10px 15px -3px rgba(0, 0, 0, 0.1), 0px 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .gantt_cal_ltext textarea {
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-family: var(--font-family-base);
            transition: border-color 0.2s;
        }

        .gantt_cal_ltext textarea:focus {
            border-color: var(--primary-color);
            border-width: 2px;
            outline: none;
        }

        /* 13. å¯æ‹–åŠ¨åˆ†éš”çº¿æ ·å¼ */
        .gantt_resizer,
        .resizer_cell,
        .gantt_layout_cell_resizer {
            width: 6px !important;
            background: #E5E7EB !important;
            cursor: col-resize !important;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .gantt_resizer:hover,
        .resizer_cell:hover,
        .gantt_layout_cell_resizer:hover {
            background: var(--primary-color) !important;
        }

        .gantt_resizer::after,
        .resizer_cell::after,
        .gantt_layout_cell_resizer::after {
            content: 'â‹®';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #9CA3AF;
            font-size: 14px;
            pointer-events: none;
        }

        .gantt_resizer:hover::after,
        .resizer_cell:hover::after,
        .gantt_layout_cell_resizer:hover::after {
            color: white;
        }

        .gantt_resizer_x {
            width: 6px !important;
            background: #E5E7EB;
            cursor: col-resize;
            transition: background-color 0.2s ease;
        }

        .gantt_resizer_x:hover {
            background: var(--primary-color) !important;
        }

        /* 14. æ‰¹é‡é€‰ä¸­è¡Œçš„è§†è§‰åé¦ˆä¼˜åŒ– */
        .gantt_row.gantt-selected,
        .gantt_grid_data .gantt_row.gantt-selected,
        .gantt_container .gantt_row.gantt-selected {
            background-color: rgba(59, 130, 246, 0.15) !important;
            border-left: 3px solid #3b82f6 !important;
            transition: all 0.2s ease;
            box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.1);
        }

        .gantt_row.gantt-selected.odd,
        .gantt_grid_data .gantt_row.gantt-selected.odd {
            background-color: rgba(59, 130, 246, 0.15) !important;
        }

        .gantt_task_row.gantt-selected,
        .gantt_data_area .gantt_task_row.gantt-selected,
        .gantt_container .gantt_task_row.gantt-selected {
            background-color: rgba(59, 130, 246, 0.15) !important;
            transition: all 0.2s ease;
        }

        .gantt_task_row.gantt-selected.odd,
        .gantt_data_area .gantt_task_row.gantt-selected.odd {
            background-color: rgba(59, 130, 246, 0.15) !important;
        }

        .gantt_row.gantt-selected:hover,
        .gantt_grid_data .gantt_row.gantt-selected:hover {
            background-color: rgba(59, 130, 246, 0.25) !important;
        }

        .gantt_task_row.gantt-selected:hover,
        .gantt_data_area .gantt_task_row.gantt-selected:hover {
            background-color: rgba(59, 130, 246, 0.25) !important;
        }

        /* é€‰ä¸­è¡Œçš„å•å…ƒæ ¼æ ·å¼ */
        .gantt_row.gantt-selected .gantt_cell,
        .gantt_grid_data .gantt_row.gantt-selected .gantt_cell {
            background-color: transparent !important;
        }

        /* é€‰ä¸­è¡Œçš„å¤é€‰æ¡†é«˜äº® */
        .gantt_row.gantt-selected .gantt-checkbox-selection {
            accent-color: #3b82f6;
        }
    </style>
</head>

<body>
    <div id="gantt_here"></div>

    <!-- å­—æ®µç®¡ç†å·¥å…·æ  -->
    <div id="field-toolbar">
        <button id="add-field-btn" style="background: #4A90E2; color: white;">+ æ–°å¢å­—æ®µ</button>
        <button id="batch-edit-btn" style="background: #6B7280; color: white;">æ‰¹é‡ç¼–è¾‘</button>
        <button id="config-export-btn" style="background: #22C55E; color: white;">ğŸ“¤ å¯¼å‡º</button>
        <button id="config-import-btn" style="background: #6B7280; color: white;">ğŸ“¥ å¯¼å…¥</button>
    </div>

    <!-- é€‰ä¸­ä»»åŠ¡è®¡æ•°å™¨ -->
    <div id="selected-tasks-counter">
        <span style="color: #0C4A6E; font-size: 14px; font-weight: 500;">
            å·²é€‰ä¸­ <span id="selected-count">0</span> ä¸ªä»»åŠ¡
        </span>
        <button id="clear-selection-btn" class="btn-secondary" style="padding: 4px 12px; font-size: 12px;">æ¸…é™¤é€‰æ‹©</button>
    </div>

    <!-- P1åŠŸèƒ½: æ‰¹é‡ç¼–è¾‘é¢æ¿ -->
    <div id="batch-edit-panel">
        <div class="batch-edit-header">
            <h3>æ‰¹é‡ç¼–è¾‘</h3>
            <button id="close-batch-edit"
                style="background: none; border: none; font-size: 24px; color: #6B7280; cursor: pointer;">&times;</button>
        </div>
        <div class="batch-edit-body">
            <div style="background: #E0F2FE; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                <span style="color: #0C4A6E; font-size: 14px;">â„¹ï¸ å·²é€‰ä¸­ <strong id="batch-selected-count">0</strong>
                    ä¸ªä»»åŠ¡</span>
            </div>
            <div class="form-group">
                <label>é€‰æ‹©è¦ä¿®æ”¹çš„å­—æ®µ</label>
                <select id="batch-field-select" class="form-control">
                    <option value="">è¯·é€‰æ‹©å­—æ®µ</option>
                </select>
            </div>
            <div id="batch-field-input-container" style="display: none;">
                <div class="form-group">
                    <label id="batch-field-label">å­—æ®µå€¼</label>
                    <div id="batch-field-input"></div>
                </div>
            </div>
        </div>
        <div class="batch-edit-footer">
            <button id="batch-cancel-btn" class="btn-secondary">å–æ¶ˆ</button>
            <button id="batch-apply-btn" class="btn-primary">åº”ç”¨åˆ°æ‰€æœ‰ä»»åŠ¡</button>
        </div>
    </div>

    <!-- P1åŠŸèƒ½: å­—æ®µç®¡ç†é¢æ¿ -->
    <div id="field-management-panel">
        <div class="field-management-header">
            <h4 style="margin: 0; font-size: 14px; font-weight: 600;">å­—æ®µç®¡ç†</h4>
            <button id="close-field-management"
                style="background: none; border: none; font-size: 24px; color: #6B7280; cursor: pointer;">&times;</button>
        </div>
        <div class="field-management-body" id="field-list-container">
            <!-- å­—æ®µåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div style="padding: 16px; background: white; border-top: 1px solid var(--border-color);">
            <button id="add-field-from-panel-btn" class="btn-secondary" style="width: 100%;">+ æ–°å¢å­—æ®µ</button>
        </div>
    </div>

    <!-- å­—æ®µé…ç½®å¼¹çª— -->
    <div id="field-config-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <h3>å­—æ®µé…ç½®</h3>
            <div class="form-group">
                <label>å­—æ®µåç§°</label>
                <input type="text" id="field-name" class="form-control" placeholder="è¯·è¾“å…¥å­—æ®µåç§°">
            </div>
            <div class="form-group">
                <label>å­—æ®µç±»å‹</label>
                <select id="field-type" class="form-control">
                    <option value="text">æ–‡æœ¬</option>
                    <option value="select">ä¸‹æ‹‰é€‰æ‹©(å•é€‰)</option>
                    <option value="multiselect">ä¸‹æ‹‰é€‰æ‹©(å¤šé€‰)</option>
                    <option value="number">æ•°å€¼</option>
                </select>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="field-required">
                    <span>å¿…å¡«å­—æ®µ</span>
                </label>
            </div>
            <div class="form-group">
                <label>é»˜è®¤å€¼ (å¯é€‰)</label>
                <input type="text" id="field-default-value" class="form-control" placeholder="ç°æœ‰ä»»åŠ¡å°†è‡ªåŠ¨å¡«å……æ­¤å€¼">
                <div style="font-size: 12px; color: #6B7280; margin-top: 4px;">æ–°å¢å­—æ®µæ—¶ï¼Œæ‰€æœ‰ç°æœ‰ä»»åŠ¡å°†è¢«è®¾ç½®ä¸ºæ­¤é»˜è®¤å€¼ã€‚</div>
            </div>
            <div id="options-config" class="form-group" style="display: none;">
                <label>é€‰é¡¹é…ç½®</label>
                <div id="options-list"></div>
                <button id="add-option-btn" class="btn-secondary"
                    style="margin-top: 8px; padding: 6px 12px; font-size: 13px;">+ æ·»åŠ é€‰é¡¹</button>
            </div>
            <div style="text-align: right; margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                <button id="cancel-field-btn" class="btn-secondary">å–æ¶ˆ</button>
                <button id="save-field-btn" class="btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶è¾“å…¥(ç”¨äºå¯¼å…¥é…ç½®) -->
    <input type="file" id="config-file-input" style="display: none;" accept=".json">

    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <script src="https://cdn.dhtmlx.com/gantt/edge/locale/locale_cn.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        // ========== æ•°æ®å’ŒçŠ¶æ€ç®¡ç† ==========
        let customFields = [
            { name: "priority", label: "ä¼˜å…ˆçº§", type: "select", options: ["é«˜", "ä¸­", "ä½"], width: 80, required: false },
            { name: "assignee", label: "è´Ÿè´£äºº", type: "text", width: 100, required: true },
            { name: "status", label: "çŠ¶æ€", type: "select", options: ["å¾…å¼€å§‹", "è¿›è¡Œä¸­", "å·²å®Œæˆ", "å·²æš‚åœ"], width: 100, required: false }
        ];

        let fieldOrder = ["text", "priority", "assignee", "status", "start_date", "duration", "progress"];
        let sortableInstance = null;
        let selectedTasks = new Set(); // P1åŠŸèƒ½: æ‰¹é‡é€‰æ‹©çš„ä»»åŠ¡é›†åˆ
        let isCtrlPressed = false;

        // å…¨å±€ä½œç”¨åŸŸçš„ addOptionInput å‡½æ•°
        function addOptionInput(value = '') {
            const optionsList = document.getElementById('options-list');
            const optionDiv = document.createElement('div');
            optionDiv.style.marginBottom = '8px';
            optionDiv.style.display = 'flex';
            optionDiv.style.gap = '8px';
            optionDiv.innerHTML = `
                <input type="text" value="${value}" placeholder="é€‰é¡¹å€¼" style="flex: 1; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 13px;">
                <button type="button" onclick="this.parentElement.remove()" style="padding: 6px 12px; background: #EF4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">åˆ é™¤</button>
            `;
            optionsList.appendChild(optionDiv);
        }

        // ========== P0åŠŸèƒ½: Toastæç¤ºç»„ä»¶ ==========
        function showToast(message, type = 'success', duration = 2000) {
            const existingToast = document.querySelector('.gantt-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'gantt-toast';

            const bgColor = type === 'success' ? '#ECFDF5' : '#FEF2F2';
            const borderColor = type === 'success' ? '#22C55E' : '#EF4444';
            const textColor = type === 'success' ? '#065F46' : '#991B1B';
            const icon = type === 'success' ? 'âœ“' : 'âœ—';

            toast.innerHTML = `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px; cursor: pointer;">
                    <span style="color: ${borderColor}; font-size: 18px; font-weight: bold;">${icon}</span>
                    <span style="color: ${textColor}; font-size: 14px; font-weight: 500;">${message}</span>
                    <span style="background: none; border: none; color: ${textColor}; cursor: pointer; font-size: 18px; margin-left: 8px;">&times;</span>
                </div>
            `;

            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%) translateY(-10px);
                z-index: 99999;
                opacity: 0;
                transition: all 0.3s ease;
            `;

            // ç‚¹å‡»æ•´ä¸ªToastå…³é—­
            toast.addEventListener('click', function () {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(-10px)';
                setTimeout(() => toast.remove(), 300);
            });

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(0)';
            }, 10);

            if (type === 'success' && duration > 0) {
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(-50%) translateY(-10px)';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }

        // ========== P0åŠŸèƒ½: å­—æ®µéªŒè¯ ==========
        function validateField(field, value) {
            if (field.required && !value) {
                return { valid: false, message: 'æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹' };
            }
            if (field.type === 'number' && value && isNaN(value)) {
                return { valid: false, message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—' };
            }
            return { valid: true };
        }

        // ========== P0åŠŸèƒ½: åŠ¨æ€é«˜åº¦è®¡ç®— ==========
        function calculateCustomFieldsHeight() {
            const fieldCount = customFields.length;
            let height;

            if (fieldCount <= 3) {
                height = fieldCount * 70 + 80;
            } else if (fieldCount <= 6) {
                const rows = Math.ceil(fieldCount / 2);
                height = rows * 86 + 80;
            } else {
                height = Math.min(window.innerHeight * 0.4, 400);
            }

            return Math.max(height, 200);
        }

        // ========== P1åŠŸèƒ½: å­—æ®µç®¡ç†é¢æ¿ ==========
        function openFieldManagementPanel() {
            const panel = document.getElementById('field-management-panel');
            panel.classList.add('open');
            renderFieldList();
        }

        function closeFieldManagementPanel() {
            const panel = document.getElementById('field-management-panel');
            panel.classList.remove('open');
        }

        function renderFieldList() {
            const container = document.getElementById('field-list-container');
            let html = '';

            customFields.forEach((field, index) => {
                html += `
                    <div class="field-item" data-field-name="${field.name}">
                        <div class="field-drag-handle">â‹®â‹®</div>
                        <div class="field-info">
                            <div class="field-name">${field.label}${field.required ? ' <span style="color: #EF4444;">*</span>' : ''}</div>
                            <div class="field-type-badge">${getFieldTypeLabel(field.type)}</div>
                        </div>
                        <div class="field-actions">
                            <button class="field-action-btn" onclick="editField('${field.name}')" title="ç¼–è¾‘">âœï¸</button>
                            <button class="field-action-btn" onclick="deleteField('${field.name}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // åˆå§‹åŒ–å­—æ®µæ‹–æ‹½æ’åº
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            sortableInstance = new Sortable(container, {
                animation: 150,
                handle: '.field-drag-handle',
                onEnd: function (evt) {
                    const movedField = customFields.splice(evt.oldIndex, 1)[0];
                    customFields.splice(evt.newIndex, 0, movedField);

                    // æ›´æ–°fieldOrder
                    fieldOrder = ["text", ...customFields.map(f => f.name), "start_date", "duration", "progress"];

                    updateGanttColumns();
                    refreshLightbox();
                }
            });
        }

        function getFieldTypeLabel(type) {
            const labels = {
                'text': 'æ–‡æœ¬',
                'number': 'æ•°å€¼',
                'select': 'å•é€‰',
                'multiselect': 'å¤šé€‰'
            };
            return labels[type] || type;
        }

        function editField(fieldName) {
            const field = customFields.find(f => f.name === fieldName);
            if (!field) return;

            document.getElementById('field-name').value = field.label;
            document.getElementById('field-type').value = field.type;
            document.getElementById('field-name').value = field.label;
            document.getElementById('field-type').value = field.type;
            document.getElementById('field-required').checked = field.required || false;
            document.getElementById('field-default-value').value = ''; // ç¼–è¾‘æ—¶ä¸å¡«å……é»˜è®¤å€¼è¾“å…¥æ¡†ï¼Œé¿å…æ··æ·†

            const optionsConfig = document.getElementById('options-config');
            if (field.type === 'select' || field.type === 'multiselect') {
                optionsConfig.style.display = 'block';
                const optionsList = document.getElementById('options-list');
                optionsList.innerHTML = '';

                if (field.options) {
                    field.options.forEach(option => {
                        addOptionInput(option);
                    });
                }
            } else {
                optionsConfig.style.display = 'none';
            }

            const modal = document.getElementById('field-config-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);

            // æ ‡è®°ä¸ºç¼–è¾‘æ¨¡å¼
            modal.dataset.editMode = 'true';
            modal.dataset.editFieldName = fieldName;
        }

        function deleteField(fieldName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å­—æ®µ "${customFields.find(f => f.name === fieldName)?.label}" å—?`)) {
                return;
            }

            customFields = customFields.filter(f => f.name !== fieldName);
            fieldOrder = fieldOrder.filter(f => f !== fieldName);

            updateGanttColumns();
            refreshLightbox();
            renderFieldList();
            showToast('å­—æ®µåˆ é™¤æˆåŠŸ', 'success');
        }

        // ========== P1åŠŸèƒ½: æ‰¹é‡ç¼–è¾‘ ==========
        function updateSelectedTasksUI() {
            const counter = document.getElementById('selected-tasks-counter');
            const count = selectedTasks.size;

            if (count > 0) {
                counter.classList.add('show');
                document.getElementById('selected-count').textContent = count;
            } else {
                counter.classList.remove('show');
            }

            // ä¸è°ƒç”¨ gantt.render()ï¼Œé¿å…é‡æ–°æ¸²æŸ“å¯¼è‡´æ ·å¼ä¸¢å¤±
            // ç›´æ¥æ›´æ–° DOM æ ·å¼

            // ä½¿ç”¨å¤šä¸ªå»¶è¿Ÿæ—¶é—´ç¡®ä¿æ ·å¼è¢«æ­£ç¡®åº”ç”¨
            applySelectionStyles();
            setTimeout(applySelectionStyles, 50);
            setTimeout(applySelectionStyles, 150);

            // æ›´æ–°å…¨é€‰CheckboxçŠ¶æ€
            const selectAll = document.getElementById('select-all-checkbox');
            if (selectAll) {
                const allTaskIds = [];
                gantt.eachTask(task => allTaskIds.push(task.id));
                const allSelected = allTaskIds.length > 0 && allTaskIds.every(id => selectedTasks.has(id));
                const someSelected = allTaskIds.some(id => selectedTasks.has(id));

                selectAll.checked = allSelected;
                selectAll.indeterminate = someSelected && !allSelected;
            }
        }

        // å•ç‹¬çš„æ ·å¼åº”ç”¨å‡½æ•°ï¼Œå¯è¢«å¤šæ¬¡è°ƒç”¨
        function applySelectionStyles() {
            // é¦–å…ˆæ¸…é™¤æ‰€æœ‰é€‰ä¸­æ ·å¼
            document.querySelectorAll('.gantt_row.gantt-selected').forEach(row => {
                row.classList.remove('gantt-selected');
                row.style.backgroundColor = '';
                row.style.borderLeft = '';
            });
            document.querySelectorAll('.gantt_task_row.gantt-selected').forEach(row => {
                row.classList.remove('gantt-selected');
                row.style.backgroundColor = '';
            });

            // éå†æ‰€æœ‰é€‰ä¸­çš„ä»»åŠ¡å¹¶åº”ç”¨æ ·å¼
            selectedTasks.forEach(taskId => {
                // æŸ¥æ‰¾å·¦ä¾§è¡¨æ ¼è¡Œ - ä½¿ç”¨ task_id å±æ€§
                const gridRows = document.querySelectorAll(`.gantt_row[task_id="${taskId}"]`);
                gridRows.forEach(row => {
                    row.classList.add('gantt-selected');
                    row.style.backgroundColor = 'rgba(59, 130, 246, 0.15)';
                    row.style.borderLeft = '3px solid #3b82f6';
                    row.style.boxSizing = 'border-box';

                    // åŒæ­¥å¤é€‰æ¡†çŠ¶æ€
                    const checkbox = row.querySelector('.gantt-checkbox-selection');
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

                // æŸ¥æ‰¾å³ä¾§æ—¶é—´è½´è¡Œ - ä½¿ç”¨ task_id å±æ€§
                const taskRows = document.querySelectorAll(`.gantt_task_row[task_id="${taskId}"]`);
                taskRows.forEach(row => {
                    row.classList.add('gantt-selected');
                    row.style.backgroundColor = 'rgba(59, 130, 246, 0.15)';
                });
            });

            // æ›´æ–°æœªé€‰ä¸­ä»»åŠ¡çš„å¤é€‰æ¡†çŠ¶æ€
            gantt.eachTask(function (task) {
                if (!selectedTasks.has(task.id)) {
                    const checkbox = document.querySelector(`.gantt-checkbox-selection[data-task-id="${task.id}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                }
            });
        }

        // åˆå§‹åŒ–è‡ªå®šä¹‰ Resizerï¼ˆä¸ demo.html ç›¸åŒå®ç°ï¼‰
        function initResizer() {
            const resizer = document.getElementById("custom-resizer");
            if (!resizer) return;

            // é¿å…é‡å¤ç»‘å®š
            if (resizer._isInitialized) return;
            resizer._isInitialized = true;

            resizer.onmousedown = function (e) {
                e.preventDefault();
                const startX = e.clientX;
                const colConfig = gantt.config.layout.cols[0];
                const startWidth = colConfig.width || 400;

                // é«˜äº®æ˜¾ç¤º resizer
                resizer.style.background = '#4A90E2';
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                function onMouseMove(e) {
                    const diff = e.clientX - startX;
                    let newWidth = startWidth + diff;
                    // åªä¿ç•™æœ€å°å®½åº¦é™åˆ¶ï¼Œç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ï¼Œå…è®¸ç”¨æˆ·è‡ªç”±æ‹–åŠ¨
                    if (newWidth < 200) newWidth = 200;

                    // æ›´æ–° Layout é…ç½®å¹¶é‡ç»˜
                    colConfig.width = newWidth;
                    gantt.resetLayout();
                }

                function onMouseUp() {
                    document.removeEventListener("mousemove", onMouseMove);
                    document.removeEventListener("mouseup", onMouseUp);

                    // æ¢å¤æ ·å¼
                    resizer.style.background = '';
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';

                    // ä¿å­˜å½“å‰å®½åº¦åˆ° localStorage
                    try {
                        localStorage.setItem('gantt_grid_width', colConfig.width);
                    } catch (e) {
                        console.warn('æ— æ³•ä¿å­˜å®½åº¦è®¾ç½®:', e);
                    }

                    // é‡ç»˜åéœ€è¦é‡æ–°ç»‘å®šäº‹ä»¶å’Œåº”ç”¨é€‰ä¸­æ ·å¼
                    resizer._isInitialized = false;
                    initResizer();
                    setTimeout(applySelectionStyles, 100);
                }

                document.addEventListener("mousemove", onMouseMove);
                document.addEventListener("mouseup", onMouseUp);
            };
        }

        function openBatchEditPanel() {
            if (selectedTasks.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„ä»»åŠ¡', 'error', 3000);
                return;
            }

            const panel = document.getElementById('batch-edit-panel');
            panel.classList.add('open');

            document.getElementById('batch-selected-count').textContent = selectedTasks.size;

            // å¡«å……å­—æ®µé€‰æ‹©ä¸‹æ‹‰æ¡†
            const select = document.getElementById('batch-field-select');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å­—æ®µ</option>';

            customFields.forEach(field => {
                select.innerHTML += `<option value="${field.name}">${field.label}</option>`;
            });
        }

        function closeBatchEditPanel() {
            document.getElementById('batch-edit-panel').classList.remove('open');
            document.getElementById('batch-field-select').value = '';
            document.getElementById('batch-field-input-container').style.display = 'none';
        }

        function applyBatchEdit() {
            const fieldName = document.getElementById('batch-field-select').value;
            if (!fieldName) {
                showToast('è¯·é€‰æ‹©è¦ä¿®æ”¹çš„å­—æ®µ', 'error', 3000);
                return;
            }

            const field = customFields.find(f => f.name === fieldName);
            const inputContainer = document.getElementById('batch-field-input');
            let value;

            if (field.type === 'multiselect') {
                const select = inputContainer.querySelector('select');
                value = Array.from(select.selectedOptions).map(o => o.value).join(',');
            } else {
                const input = inputContainer.querySelector('input, select');
                value = input ? input.value : '';
            }

            // åº”ç”¨åˆ°æ‰€æœ‰é€‰ä¸­çš„ä»»åŠ¡
            let updateCount = 0;
            selectedTasks.forEach(taskId => {
                const task = gantt.getTask(taskId);
                task[fieldName] = value;
                gantt.updateTask(taskId);
                updateCount++;
            });

            showToast(`å·²æˆåŠŸä¿®æ”¹ ${updateCount} ä¸ªä»»åŠ¡`, 'success');
            closeBatchEditPanel();
            selectedTasks.clear();
            updateSelectedTasksUI();
        }

        // ========== ç”˜ç‰¹å›¾é…ç½® ==========
        function updateGanttColumns() {
            const columns = [];

            // P1åŠŸèƒ½: Checkbox é€‰æ‹©åˆ—
            columns.push({
                name: "buttons",
                label: '<input type="checkbox" id="select-all-checkbox" style="cursor: pointer;">',
                width: 40,
                align: "center",
                template: function (task) {
                    const checked = selectedTasks.has(task.id) ? "checked" : "";
                    return `<input type="checkbox" class="gantt-checkbox-selection" data-task-id="${task.id}" ${checked} style="cursor: pointer;">`;
                }
            });

            fieldOrder.forEach(fieldName => {
                if (fieldName === "text") {
                    columns.push({ name: "text", label: "ä»»åŠ¡åç§°", tree: true, width: 200, resize: true });
                } else if (fieldName === "start_date") {
                    columns.push({ name: "start_date", label: "å¼€å§‹æ—¶é—´", align: "center", width: 90, resize: true });
                } else if (fieldName === "duration") {
                    columns.push({ name: "duration", label: "å·¥æœŸ(å¤©)", align: "center", width: 80, resize: true });
                } else if (fieldName === "progress") {
                    columns.push({
                        name: "progress", label: "è¿›åº¦(%)", align: "center", width: 80, resize: true,
                        template: function (task) {
                            return Math.round(task.progress * 100) + "%";
                        }
                    });
                } else {
                    const customField = customFields.find(f => f.name === fieldName);
                    if (customField) {
                        columns.push({
                            name: fieldName,
                            label: customField.label,
                            align: "center",
                            width: customField.width || 100,
                            resize: true,
                            template: function (task) {
                                return task[fieldName] || '';
                            }
                        });
                    }
                }
            });

            columns.push({ name: "add", label: "", width: 44 });

            gantt.config.columns = columns;

            if (gantt.$container) {
                gantt.render();
            }
        }

        // ========== Lightboxé…ç½® ==========
        gantt.form_blocks["custom_fields"] = {
            render: function (sns) {
                const height = calculateCustomFieldsHeight();
                return "<div class='gantt_cal_ltext gantt_custom_fields_container' style='height:" + height + "px;'></div>";
            },
            set_value: function (node, value, task, section) {
                const fieldCount = customFields.length;
                let layoutClass = 'single-column';

                if (fieldCount > 3 && fieldCount <= 6) {
                    layoutClass = 'two-column';
                } else if (fieldCount > 6) {
                    layoutClass = 'two-column scrollable';
                }

                let html = '<div class="custom-fields-section" style="padding: 16px; height: 100%; box-sizing: border-box;">';

                // æ ‡é¢˜å’Œç®¡ç†å­—æ®µæŒ‰é’®
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
                html += '<h4 style="margin: 0; color: #1F2937; font-size: 14px; font-weight: 600;">è‡ªå®šä¹‰å­—æ®µ</h4>';
                html += '<button id="manage-fields-btn" type="button" style="padding: 6px 12px; background: transparent; color: #4A90E2; border: 1px solid #4A90E2; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;">âš™ï¸ ç®¡ç†å­—æ®µ</button>';
                html += '</div>';

                html += `<div class="fields-grid ${layoutClass}" style="max-height: ${fieldCount > 6 ? 'calc(100% - 60px)' : 'auto'}; overflow-y: ${fieldCount > 6 ? 'auto' : 'visible'};">`;

                customFields.forEach(field => {
                    const fieldValue = task[field.name] || '';
                    const requiredMark = field.required ? '<span style="color: #EF4444; margin-left: 4px;">*</span>' : '';

                    html += `<div class="custom-field-item" style="margin-bottom: 16px;">`;
                    html += `<label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151; font-size: 13px;">${field.label}${requiredMark}:</label>`;

                    const inputStyle = 'width: 100%; padding: 10px 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 13px; box-sizing: border-box; transition: border-color 0.2s;';
                    const focusEvents = 'onfocus="this.style.borderColor=\'#4A90E2\'; this.style.borderWidth=\'2px\'" onblur="this.style.borderColor=\'#D1D5DB\'; this.style.borderWidth=\'1px\'"';

                    if (field.type === 'text') {
                        html += `<input type="text" name="${field.name}" value="${fieldValue}" ${field.required ? 'required' : ''} style="${inputStyle}" ${focusEvents}>`;
                    } else if (field.type === 'number') {
                        html += `<input type="number" name="${field.name}" value="${fieldValue}" ${field.required ? 'required' : ''} style="${inputStyle}" ${focusEvents}>`;
                    } else if (field.type === 'select') {
                        html += `<select name="${field.name}" ${field.required ? 'required' : ''} style="${inputStyle}" ${focusEvents}>`;
                        html += `<option value="">è¯·é€‰æ‹©</option>`;
                        field.options.forEach(option => {
                            const selected = fieldValue === option ? 'selected' : '';
                            html += `<option value="${option}" ${selected}>${option}</option>`;
                        });
                        html += `</select>`;
                    } else if (field.type === 'multiselect') {
                        const selectedValues = Array.isArray(fieldValue) ? fieldValue : (fieldValue ? fieldValue.split(',') : []);
                        html += `<select name="${field.name}" multiple ${field.required ? 'required' : ''} style="${inputStyle} min-height: 80px;" ${focusEvents}>`;
                        field.options.forEach(option => {
                            const selected = selectedValues.includes(option) ? 'selected' : '';
                            html += `<option value="${option}" ${selected}>${option}</option>`;
                        });
                        html += `</select>`;
                    }

                    html += `<div class="field-error" data-field="${field.name}" style="color: #EF4444; font-size: 12px; margin-top: 4px; display: none;"></div>`;
                    html += `</div>`;
                });

                html += '</div></div>';
                node.innerHTML = html;

                setTimeout(() => {
                    const manageBtn = node.querySelector('#manage-fields-btn');
                    if (manageBtn) {
                        manageBtn.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openFieldManagementPanel();
                        });
                    }
                }, 100);
            },
            get_value: function (node, task, section) {
                let isValid = true;
                const errors = [];

                customFields.forEach(field => {
                    const input = node.querySelector(`input[name="${field.name}"], select[name="${field.name}"]`);
                    const errorDiv = node.querySelector(`.field-error[data-field="${field.name}"]`);

                    if (input) {
                        let value = '';

                        if (field.type === 'multiselect') {
                            const selectedOptions = Array.from(input.selectedOptions).map(option => option.value);
                            value = selectedOptions.join(',');
                            task[field.name] = value;
                        } else {
                            value = input.value;
                            task[field.name] = value;
                        }

                        const validation = validateField(field, value);
                        if (!validation.valid) {
                            isValid = false;
                            errors.push({ field: field.name, message: validation.message });

                            input.style.borderColor = '#EF4444';
                            input.style.borderWidth = '2px';
                            if (errorDiv) {
                                errorDiv.textContent = validation.message;
                                errorDiv.style.display = 'block';
                            }
                        } else {
                            input.style.borderColor = '#D1D5DB';
                            input.style.borderWidth = '1px';
                            if (errorDiv) {
                                errorDiv.style.display = 'none';
                            }
                        }
                    }
                });

                if (!isValid) {
                    setTimeout(() => {
                        showToast(errors[0].message, 'error', 0);
                    }, 100);

                    const firstErrorField = node.querySelector(`input[name="${errors[0].field}"], select[name="${errors[0].field}"]`);
                    if (firstErrorField) {
                        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstErrorField.focus();
                    }
                }

                task._validation_passed = isValid;
                return task.custom_fields;
            },
            focus: function (node) {
                const firstInput = node.querySelector('input, select');
                if (firstInput) firstInput.focus();
            }
        };

        gantt.config.lightbox.sections = [
            { name: "description", height: 70, map_to: "text", type: "textarea", focus: true },
            { name: "time", height: 72, type: "duration", map_to: "auto" },
            { name: "custom_fields", height: calculateCustomFieldsHeight(), type: "custom_fields", map_to: "custom_fields" }
        ];

        function refreshLightbox() {
            if (gantt.getLightbox()) {
                gantt.hideLightbox();
            }

            const existingLightbox = document.querySelector('.gantt_cal_light');
            if (existingLightbox) {
                existingLightbox.remove();
            }

            gantt.config.lightbox.sections = [
                { name: "description", height: 70, map_to: "text", type: "textarea", focus: true },
                { name: "time", height: 72, type: "duration", map_to: "auto" },
                { name: "custom_fields", height: calculateCustomFieldsHeight(), type: "custom_fields", map_to: "custom_fields" }
            ];

            gantt._lightbox = null;
        }



        // ========== ç”˜ç‰¹å›¾åˆå§‹åŒ– ==========
        gantt.i18n.setLocale("cn");

        gantt.config.scales = [
            {
                unit: "month",
                step: 1,
                format: function (date) {
                    return date.getFullYear() + "å¹´" + (date.getMonth() + 1) + "æœˆ";
                }
            },
            {
                unit: "day",
                step: 1,
                format: function (date) {
                    return (date.getMonth() + 1) + "æœˆ" + date.getDate() + "æ—¥";
                },
                css: function (date) {
                    if (date.getDay() === 0 || date.getDay() === 6) {
                        return "weekend";
                    }
                    return "";
                }
            }
        ];

        gantt.templates.task_class = function (start, end, task) {
            if (task.progress < 1 && new Date() > end) {
                return "task_overdue";
            }
            return "";
        };

        // P1åŠŸèƒ½: æ‰¹é‡é€‰æ‹© - ç½‘æ ¼è¡Œé«˜äº®æ¨¡æ¿
        gantt.templates.grid_row_class = function (start, end, task) {
            if (selectedTasks.has(task.id)) {
                return "gantt-selected";
            }
            return "";
        };

        // P1åŠŸèƒ½: æ‰¹é‡é€‰æ‹© - æ—¶é—´è½´è¡Œé«˜äº®æ¨¡æ¿
        gantt.templates.task_row_class = function (start, end, task) {
            if (selectedTasks.has(task.id)) {
                return "gantt-selected";
            }
            return "";
        };

        // ä» localStorage æ¢å¤å·¦ä¾§å®½åº¦è®¾ç½®
        let savedGridWidth = 400; // é»˜è®¤å®½åº¦
        try {
            const saved = localStorage.getItem('gantt_grid_width');
            if (saved) {
                savedGridWidth = parseInt(saved, 10);
                // åªä¿ç•™æœ€å°å®½åº¦é™åˆ¶ï¼Œç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶
                if (savedGridWidth < 200) savedGridWidth = 200;
            }
        } catch (e) {
            console.warn('æ— æ³•è¯»å–å®½åº¦è®¾ç½®:', e);
        }

        // é…ç½® DHTMLX Native Layout
        // ä½¿ç”¨è‡ªå®šä¹‰ HTML å…ƒç´ ä½œä¸º Resizerï¼Œä»¥å…¼å®¹ Standard ç‰ˆæœ¬
        gantt.config.layout = {
            css: "gantt_container",
            cols: [
                {
                    width: savedGridWidth,
                    min_width: 200,
                    rows: [
                        { view: "grid", scrollX: "gridScroll", scrollY: "scrollVer" },
                        { view: "scrollbar", id: "gridScroll", group: "horizontal" }
                    ]
                },
                {
                    width: 6,
                    html: "<div id='custom-resizer' style='width:100%;height:100%;background:#E5E7EB;cursor:col-resize;border-left:1px solid #D1D5DB;border-right:1px solid #D1D5DB;transition:background 0.2s;'></div>"
                },
                {
                    rows: [
                        { view: "timeline", scrollX: "scrollHor", scrollY: "scrollVer" },
                        { view: "scrollbar", id: "scrollHor", group: "horizontal" }
                    ]
                },
                { view: "scrollbar", id: "scrollVer" }
            ]
        };

        // ä¿å­˜ç½‘æ ¼å®½åº¦åˆ° localStorage
        gantt.attachEvent("onGridResizeEnd", function (old_width, new_width) {
            localStorage.setItem('gantt_grid_width', new_width);
            return true;
        });

        // P0åŠŸèƒ½: ä¿å­˜æ“ä½œæ‹¦æˆªå’Œåé¦ˆ
        gantt.attachEvent("onLightboxSave", function (id, task, is_new) {
            if (task._validation_passed === false) {
                return false; // é˜»æ­¢ä¿å­˜
            }

            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
            showToast('ä¿å­˜æˆåŠŸ', 'success', 2000);

            // 1ç§’åå…³é—­å¼¹çª—
            setTimeout(() => {
                gantt.hideLightbox();
            }, 1000);

            return true;
        });

        // P1åŠŸèƒ½: ç›‘å¬ä»»åŠ¡è¡Œç‚¹å‡»äº‹ä»¶(æ‰¹é‡é€‰æ‹©)
        gantt.attachEvent("onTaskClick", function (id, e) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†æˆ–å¤é€‰æ¡†æ‰€åœ¨çš„å•å…ƒæ ¼ï¼Œå®Œå…¨è·³è¿‡ï¼Œè®©å¤é€‰æ¡†äº‹ä»¶å¤„ç†å™¨å¤„ç†
            if (e.target) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å¤é€‰æ¡†æœ¬èº«
                if (e.target.classList && e.target.classList.contains('gantt-checkbox-selection')) {
                    return true;
                }
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å¤é€‰æ¡†æ‰€åœ¨çš„å•å…ƒæ ¼ï¼ˆç¬¬ä¸€åˆ—ï¼‰
                const cell = e.target.closest('.gantt_cell');
                if (cell) {
                    const checkbox = cell.querySelector('.gantt-checkbox-selection');
                    if (checkbox) {
                        return true; // è·³è¿‡ï¼Œè®©å¤é€‰æ¡†å¤„ç†å™¨å¤„ç†
                    }
                }
            }

            // åªæœ‰æŒ‰ä½ Ctrl/Meta é”®ç‚¹å‡»éå¤é€‰æ¡†åŒºåŸŸæ—¶æ‰è§¦å‘æ‰¹é‡é€‰æ‹©
            if (isCtrlPressed || e.ctrlKey || e.metaKey) {
                if (selectedTasks.has(id)) {
                    selectedTasks.delete(id);
                } else {
                    selectedTasks.add(id);
                }
                updateSelectedTasksUI();
                return false; // é˜»æ­¢é»˜è®¤è¡Œä¸º
            }
            return true;
        });

        updateGanttColumns();

        gantt.init("gantt_here");
        var tasks = {
            data: [
                { id: 1, text: "é¡¹ç›® #1", start_date: "2025-10-01", duration: 18, progress: 0.4, open: true, priority: "é«˜", assignee: "å¼ ä¸‰", status: "è¿›è¡Œä¸­" },
                { id: 2, text: "ä»»åŠ¡ #1", start_date: "2025-10-02", duration: 8, progress: 0.6, parent: 1, priority: "ä¸­", assignee: "æå››", status: "è¿›è¡Œä¸­" },
                { id: 3, text: "ä»»åŠ¡ #2", start_date: "2025-10-11", duration: 8, progress: 0.2, parent: 1, priority: "ä½", assignee: "ç‹äº”", status: "å¾…å¼€å§‹" }
            ],
            links: [
                { id: 1, source: 2, target: 3, type: "0" }
            ]
        };

        gantt.parse(tasks);

        // ç”˜ç‰¹å›¾æ¸²æŸ“åé‡æ–°åº”ç”¨é€‰ä¸­æ ·å¼
        gantt.attachEvent("onGanttRender", function () {
            if (selectedTasks.size > 0) {
                setTimeout(updateSelectedTasksUI, 50);
            }
        });

        // ========== äº‹ä»¶ç»‘å®š ==========
        document.addEventListener('DOMContentLoaded', function () {
            // Ctrlé”®ç›‘å¬
            document.addEventListener('keydown', function (e) {
                if (e.ctrlKey || e.metaKey) {
                    isCtrlPressed = true;
                }
            });

            document.addEventListener('keyup', function (e) {
                if (!e.ctrlKey && !e.metaKey) {
                    isCtrlPressed = false;
                }
            });

            // å¤é€‰æ¡†äº‹ä»¶å§”æ‰˜ - å•ä¸ªä»»åŠ¡é€‰æ‹©
            // ä½¿ç”¨ change äº‹ä»¶è€Œé clickï¼Œé¿å…ä¸ Ctrl+ç‚¹å‡»å†²çª
            gantt.$grid.addEventListener('change', function (e) {
                if (e.target.classList.contains('gantt-checkbox-selection')) {
                    const taskId = parseInt(e.target.getAttribute('data-task-id'));
                    // ç›´æ¥æ ¹æ®å¤é€‰æ¡†çš„å½“å‰çŠ¶æ€æ¥æ›´æ–°
                    if (e.target.checked) {
                        selectedTasks.add(taskId);
                    } else {
                        selectedTasks.delete(taskId);
                    }
                    updateSelectedTasksUI();
                    e.stopPropagation();
                }
            });

            // å…¨é€‰å¤é€‰æ¡†äº‹ä»¶å§”æ‰˜
            gantt.$grid_scale.addEventListener('click', function (e) {
                if (e.target.id === 'select-all-checkbox') {
                    const allTaskIds = [];
                    gantt.eachTask(task => allTaskIds.push(task.id));

                    if (e.target.checked) {
                        allTaskIds.forEach(id => selectedTasks.add(id));
                    } else {
                        selectedTasks.clear();
                    }
                    updateSelectedTasksUI();
                    e.stopPropagation();
                }
            });

            // ========== åˆå§‹åŒ–è‡ªå®šä¹‰ Resizer ==========
            // ä¸ demo.html ç›¸åŒçš„å®ç°ï¼Œä½¿ç”¨ gantt.resetLayout() å®ç°å®æ—¶è°ƒæ•´
            initResizer();

            // æ–°å¢å­—æ®µæŒ‰é’®
            document.getElementById('add-field-btn').addEventListener('click', function () {
                const modal = document.getElementById('field-config-modal');
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('show'), 10);

                document.getElementById('field-name').value = '';
                document.getElementById('field-type').value = 'text';
                document.getElementById('field-required').checked = false;
                document.getElementById('field-default-value').value = '';
                document.getElementById('options-config').style.display = 'none';
                document.getElementById('options-list').innerHTML = '';

                delete modal.dataset.editMode;
                delete modal.dataset.editFieldName;
            });

            document.getElementById('add-field-from-panel-btn').addEventListener('click', function () {
                document.getElementById('add-field-btn').click();
            });

            // æ‰¹é‡ç¼–è¾‘æŒ‰é’®
            document.getElementById('batch-edit-btn').addEventListener('click', openBatchEditPanel);
            document.getElementById('close-batch-edit').addEventListener('click', closeBatchEditPanel);
            document.getElementById('batch-cancel-btn').addEventListener('click', closeBatchEditPanel);
            document.getElementById('batch-apply-btn').addEventListener('click', applyBatchEdit);

            // å­—æ®µç®¡ç†é¢æ¿
            document.getElementById('close-field-management').addEventListener('click', closeFieldManagementPanel);

            // æ¸…é™¤é€‰æ‹©æŒ‰é’®
            document.getElementById('clear-selection-btn').addEventListener('click', function () {
                selectedTasks.clear();
                updateSelectedTasksUI();
            });

            // æ‰¹é‡ç¼–è¾‘å­—æ®µé€‰æ‹©
            document.getElementById('batch-field-select').addEventListener('change', function () {
                const fieldName = this.value;
                const container = document.getElementById('batch-field-input-container');
                const inputContainer = document.getElementById('batch-field-input');
                const label = document.getElementById('batch-field-label');

                if (!fieldName) {
                    container.style.display = 'none';
                    return;
                }

                const field = customFields.find(f => f.name === fieldName);
                label.textContent = field.label;
                container.style.display = 'block';

                let inputHTML = '';
                const inputStyle = 'width: 100%; padding: 10px 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 14px; box-sizing: border-box;';

                if (field.type === 'text') {
                    inputHTML = `<input type="text" class="form-control" placeholder="è¯·è¾“å…¥${field.label}">`;
                } else if (field.type === 'number') {
                    inputHTML = `<input type="number" class="form-control" placeholder="è¯·è¾“å…¥${field.label}">`;
                } else if (field.type === 'select') {
                    inputHTML = `<select class="form-control"><option value="">è¯·é€‰æ‹©</option>`;
                    field.options.forEach(option => {
                        inputHTML += `<option value="${option}">${option}</option>`;
                    });
                    inputHTML += `</select>`;
                } else if (field.type === 'multiselect') {
                    inputHTML = `<select class="form-control" multiple style="min-height: 100px;">`;
                    field.options.forEach(option => {
                        inputHTML += `<option value="${option}">${option}</option>`;
                    });
                    inputHTML += `</select>`;
                }

                inputContainer.innerHTML = inputHTML;
            });

            // å­—æ®µç±»å‹å˜åŒ–
            document.getElementById('field-type').addEventListener('change', function () {
                const type = this.value;
                const optionsConfig = document.getElementById('options-config');
                if (type === 'select' || type === 'multiselect') {
                    optionsConfig.style.display = 'block';
                } else {
                    optionsConfig.style.display = 'none';
                }
            });

            // æ·»åŠ é€‰é¡¹æŒ‰é’®
            document.getElementById('add-option-btn').addEventListener('click', function () {
                addOptionInput('');
            });

            // ä¿å­˜å­—æ®µé…ç½®
            document.getElementById('save-field-btn').addEventListener('click', function () {
                const fieldName = document.getElementById('field-name').value.trim();
                const fieldType = document.getElementById('field-type').value;
                const fieldRequired = document.getElementById('field-required').checked;
                const fieldDefaultValue = document.getElementById('field-default-value').value.trim();
                const modal = document.getElementById('field-config-modal');

                if (!fieldName) {
                    showToast('è¯·è¾“å…¥å­—æ®µåç§°', 'error', 3000);
                    return;
                }

                const fieldConfig = {
                    name: fieldName.toLowerCase().replace(/\s+/g, '_'),
                    label: fieldName,
                    type: fieldType,
                    width: 100,
                    required: fieldRequired
                };

                if (fieldType === 'select' || fieldType === 'multiselect') {
                    const options = [];
                    document.querySelectorAll('#options-list input[type="text"]').forEach(input => {
                        if (input.value.trim()) {
                            options.push(input.value.trim());
                        }
                    });

                    if (options.length === 0) {
                        showToast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªé€‰é¡¹', 'error', 3000);
                        return;
                    }

                    fieldConfig.options = options;
                }

                // ç¼–è¾‘æ¨¡å¼æˆ–æ–°å¢æ¨¡å¼
                if (modal.dataset.editMode === 'true') {
                    const oldFieldName = modal.dataset.editFieldName;
                    const fieldIndex = customFields.findIndex(f => f.name === oldFieldName);

                    if (fieldIndex !== -1) {
                        // ä¿ç•™åŸæœ‰çš„ name,åªæ›´æ–° label å’Œå…¶ä»–å±æ€§
                        customFields[fieldIndex].label = fieldName;
                        customFields[fieldIndex].type = fieldType;
                        customFields[fieldIndex].required = fieldRequired;

                        // æ›´æ–°é€‰é¡¹é…ç½®(å¦‚æœæ˜¯é€‰æ‹©ç±»å‹)
                        if (fieldType === 'select' || fieldType === 'multiselect') {
                            const options = [];
                            document.querySelectorAll('#options-list input[type="text"]').forEach(input => {
                                if (input.value.trim()) {
                                    options.push(input.value.trim());
                                }
                            });

                            if (options.length === 0) {
                                showToast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªé€‰é¡¹', 'error', 3000);
                                return;
                            }

                            customFields[fieldIndex].options = options;
                        }
                    }

                    showToast('å­—æ®µæ›´æ–°æˆåŠŸ', 'success');
                } else {
                    customFields.push(fieldConfig);
                    fieldOrder.push(fieldConfig.name);

                    // åº”ç”¨é»˜è®¤å€¼åˆ°æ‰€æœ‰ç°æœ‰ä»»åŠ¡
                    if (fieldDefaultValue) {
                        gantt.eachTask(function (task) {
                            task[fieldConfig.name] = fieldDefaultValue;
                            gantt.updateTask(task.id); // æ›´æ–°è§†å›¾
                        });
                    }

                    showToast('å­—æ®µåˆ›å»ºæˆåŠŸ', 'success');
                }

                updateGanttColumns();
                refreshLightbox();
                renderFieldList();

                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            });

            // å–æ¶ˆå­—æ®µé…ç½®
            document.getElementById('cancel-field-btn').addEventListener('click', function () {
                const modal = document.getElementById('field-config-modal');
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            });

            // å¯¼å‡ºé…ç½®
            document.getElementById('config-export-btn').addEventListener('click', function () {
                const config = {
                    customFields: customFields,
                    fieldOrder: fieldOrder,
                    exportTime: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'gantt-fields-config.json';
                a.click();
                URL.revokeObjectURL(url);

                showToast('é…ç½®å¯¼å‡ºæˆåŠŸ', 'success');
            });

            // å¯¼å…¥é…ç½®
            document.getElementById('config-import-btn').addEventListener('click', function () {
                document.getElementById('config-file-input').click();
            });

            document.getElementById('config-file-input').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        if (config.customFields && config.fieldOrder) {
                            customFields = config.customFields;
                            fieldOrder = config.fieldOrder;
                            updateGanttColumns();
                            refreshLightbox();
                            showToast('é…ç½®å¯¼å…¥æˆåŠŸ', 'success');
                        } else {
                            showToast('é…ç½®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error', 3000);
                        }
                    } catch (error) {
                        showToast('é…ç½®æ–‡ä»¶è§£æå¤±è´¥: ' + error.message, 'error', 3000);
                    }
                };
                reader.readAsText(file);
            });
        });
    </script>
</body>

</html>