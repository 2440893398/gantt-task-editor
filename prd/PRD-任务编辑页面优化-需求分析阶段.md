# 需求文档（Product Requirements Document）

## 1. 概述
- **名称**：任务编辑页面优化
- **定位**：提升甘特图任务编辑弹窗的用户体验和操作效率，减少用户在编辑任务时的认知负担和操作成本
- **目标用户**：使用甘特图进行项目管理的团队成员，包括项目经理、任务负责人和协作成员
- **核心问题**：
  - 当前任务编辑弹窗（lightbox）的自定义字段区域高度固定（200px），当字段数量增多时会出现滚动条，影响用户体验
  - 缺乏字段管理功能的可见性和易用性，用户需要通过工具栏按钮才能管理字段
  - 编辑弹窗缺少实时保存提示，用户不确定修改是否成功保存
  - 自定义字段在任务条上的显示过于密集，影响时间轴的可读性
  - 缺乏字段验证和错误提示机制

## 2. 需求背景
当前系统基于DHTMLX Gantt实现了一个功能完整的甘特图任务管理界面，支持自定义字段、字段拖拽排序、配置导入导出等高级功能。但在实际使用过程中，任务编辑体验存在以下痛点：

1. **视觉体验问题**：自定义字段区域固定高度导致需要滚动才能查看所有字段
2. **交互效率问题**：字段管理功能隐藏在右上角工具栏，不够直观
3. **反馈机制缺失**：用户修改任务后缺少明确的保存成功提示
4. **信息密度问题**：任务条上显示过多自定义字段信息，导致时间轴拥挤

## 3. 页面架构
### 3.1 页面清单
| 页面名称 | 页面类型 | 核心功能 | 用户价值 | 用户入口 | 优先级 |
|:--------:|:--------:|:--------:|:--------:|:--------:|:--------:|
| 任务编辑弹窗 | 模态框 | 编辑任务的所有属性（名称、时间、自定义字段） | 快速修改任务信息，提升编辑效率 | 双击任务条或点击任务行 | P0 |
| 字段管理弹窗 | 模态框 | 新增、配置自定义字段 | 灵活扩展任务属性，适应不同团队需求 | 工具栏"新增字段"按钮 | P1 |
| 甘特图主界面 | 主页 | 展示任务列表、时间轴、依赖关系 | 直观了解项目进度和任务关系 | 页面加载 | P0 |

### 3.2 页面详细需求

#### 页面：任务编辑弹窗（Lightbox）优化
- **页面目标**：让用户能够高效、直观地编辑任务的所有属性，并清楚了解操作结果
- **核心功能**：
  1. 任务基本信息编辑（名称、描述）
  2. 任务时间编辑（开始时间、工期）
  3. 自定义字段编辑（动态生成的字段表单）
  4. 操作反馈提示（保存成功/失败）

- **业务逻辑**：
  1. 自定义字段区域高度应根据字段数量动态调整，避免固定高度造成的滚动问题
  2. 当字段数量超过一定阈值（如6个）时，采用分栏布局提升空间利用率
  3. 保存操作后应有明确的视觉反馈（成功提示/错误提示）
  4. 必填字段未填写时应阻止保存并给出提示

- **页面元素**：
  - 任务描述输入框（textarea）
  - 时间选择器（日期选择器 + 工期输入）
  - 自定义字段表单区域（动态生成）
  - 保存/取消按钮
  - 状态提示区域（新增）

- **交互逻辑**：
  1. 双击任务条或点击任务行打开编辑弹窗
  2. 修改字段内容后，点击"保存"按钮提交修改
  3. 保存成功后显示成功提示（2秒后自动消失），并关闭弹窗
  4. 保存失败或验证未通过时显示错误提示，不关闭弹窗
  5. 点击"取消"按钮或弹窗外部区域关闭弹窗，放弃修改

- **跳转逻辑**：
  - 保存成功后返回甘特图主界面，任务信息更新
  - 取消操作后返回甘特图主界面，任务信息不变

#### 页面：字段管理优化
- **页面目标**：提供更直观、易用的字段管理入口和配置界面
- **核心功能**：
  1. 在编辑弹窗内提供"管理字段"快捷入口
  2. 支持字段的新增、编辑、删除、排序
  3. 字段配置实时生效

- **业务逻辑**：
  1. 字段管理入口应在编辑弹窗内可见（如底部或侧边按钮）
  2. 删除字段时需要二次确认，防止误操作
  3. 修改字段配置后立即刷新弹窗，无需重新打开

- **页面元素**：
  - "管理字段"按钮（位于编辑弹窗内）
  - 字段列表（显示所有自定义字段）
  - 字段操作按钮（编辑、删除、排序）

- **交互逻辑**：
  1. 在编辑弹窗底部或自定义字段区域顶部显示"管理字段"按钮
  2. 点击按钮打开字段管理面板（可以是侧边栏或新弹窗）
  3. 在字段管理面板中可以新增、编辑、删除、拖拽排序字段
  4. 操作完成后，编辑弹窗自动刷新显示最新字段配置

- **跳转逻辑**：
  - 字段管理面板关闭后返回编辑弹窗
  - 字段配置变更后编辑弹窗自动刷新

## 4. 用户故事

### P0核心功能：

#### 4.1 动态高度的自定义字段区域
- **用户故事**：作为项目管理员，我希望任务编辑弹窗的自定义字段区域能根据字段数量自动调整高度，以便我能一次性看到所有字段，不需要滚动查看
- **业务规则**：
  - 当字段数量 ≤ 3个时，采用单栏布局，每个字段高度约50px
  - 当字段数量 > 3个时，采用双栏布局，提升空间利用率
  - 自定义字段区域最小高度200px，最大高度不超过屏幕高度的60%
  - 当字段数量过多导致高度超过最大限制时，启用垂直滚动

#### 4.2 保存操作反馈
- **用户故事**：作为任务负责人，我希望在保存任务修改后能看到明确的成功或失败提示，以便我确认操作是否生效
- **业务规则**：
  - 保存成功后在弹窗顶部显示绿色提示条"保存成功"，持续2秒后自动消失
  - 保存失败或验证错误时在弹窗顶部显示红色提示条，显示具体错误信息，需要用户手动关闭或修正错误后消失
  - 提示条应包含图标（成功✓/失败✗）和文字说明
  - 保存成功后1秒自动关闭弹窗，返回甘特图主界面

#### 4.3 字段验证机制
- **用户故事**：作为项目管理员，我希望系统能自动检查必填字段是否填写，以便避免数据不完整的任务被保存
- **业务规则**：
  - 可以配置某些自定义字段为"必填"
  - 必填字段未填写时，字段边框显示红色，并在字段下方显示提示文字"此字段为必填项"
  - 点击保存按钮时，如果有必填字段未填写，阻止保存并滚动到第一个错误字段位置
  - 所有验证通过后才允许保存

### P1重要功能：

#### 4.4 编辑弹窗内的字段管理入口
- **用户故事**：作为项目管理员，我希望在编辑任务时能快速访问字段管理功能，以便我能根据实际需求灵活调整字段配置
- **业务规则**：
  - 在自定义字段区域顶部显示"管理字段"按钮（图标+文字）
  - 点击按钮在弹窗右侧滑出字段管理面板（300px宽）
  - 面板显示所有自定义字段列表，支持拖拽排序、编辑、删除
  - 面板底部有"新增字段"按钮
  - 关闭面板后编辑弹窗自动刷新

#### 4.5 任务条信息显示优化
- **用户故事**：作为团队成员，我希望任务条上只显示最重要的信息，以便我能在时间轴上快速识别任务状态，而不被过多信息干扰
- **业务规则**：
  - 任务条默认只显示任务名称和进度百分比
  - 可以在设置中配置"任务条显示字段"，最多选择2个自定义字段显示在任务条上
  - 优先显示配置的字段：优先级用颜色标签表示（高=红色、中=黄色、低=蓝色），负责人用头像或首字母显示
  - 鼠标悬停时显示完整的任务卡片（包含所有字段信息）

#### 4.6 批量编辑功能
- **用户故事**：作为项目管理员，我希望能同时选中多个任务进行批量编辑，以便我能快速更新多个任务的相同属性（如负责人、状态）
- **业务规则**：
  - 按住Ctrl/Cmd点击任务行可以多选任务
  - 多选后右键显示"批量编辑"选项
  - 批量编辑弹窗只显示公共的自定义字段
  - 修改字段后批量应用到所有选中的任务
  - 操作完成后显示"已更新X个任务"的提示

## 5. 用户流程

### 主要操作路径：

#### 5.1 编辑单个任务
1. 用户在甘特图主界面双击任务条或任务行
2. 系统打开任务编辑弹窗，显示任务当前信息
3. 用户修改任务名称、时间或自定义字段内容
4. 用户点击"保存"按钮
5. 系统验证字段是否符合规则（必填项检查、格式检查）
6. 验证通过后保存数据，显示"保存成功"提示（2秒）
7. 弹窗自动关闭，甘特图主界面刷新显示最新数据

**异常流程**：
- 如果验证失败，显示错误提示，标记错误字段，不关闭弹窗
- 用户修正错误后重新保存

#### 5.2 管理自定义字段
1. 用户打开任务编辑弹窗
2. 用户点击自定义字段区域顶部的"管理字段"按钮
3. 系统在弹窗右侧滑出字段管理面板
4. 用户在面板中进行字段操作：
   - 新增字段：点击"新增字段"，填写字段配置，保存
   - 编辑字段：点击字段右侧的"编辑"图标，修改配置，保存
   - 删除字段：点击字段右侧的"删除"图标，确认后删除
   - 排序字段：拖拽字段调整顺序
5. 用户关闭字段管理面板
6. 系统自动刷新编辑弹窗，显示最新字段配置

#### 5.3 批量编辑任务
1. 用户在甘特图主界面按住Ctrl/Cmd点击多个任务行（至少2个）
2. 用户右键点击选中的任务，选择"批量编辑"
3. 系统打开批量编辑弹窗，显示公共自定义字段
4. 用户修改需要批量更新的字段（如"负责人"改为"李四"）
5. 用户点击"应用到所有选中任务"按钮
6. 系统批量更新所有选中任务的对应字段
7. 显示"已更新X个任务"的成功提示
8. 弹窗关闭，甘特图主界面刷新

### 页面流转图：
```
甘特图主界面
  ↓ （双击任务）
任务编辑弹窗
  ↓ （点击"管理字段"）
字段管理面板（侧边栏）
  ↓ （关闭面板）
任务编辑弹窗（自动刷新）
  ↓ （保存成功）
甘特图主界面（数据已更新）
```

## 6. 约束

### 6.1 平台要求
- **浏览器兼容性**：支持Chrome 90+、Edge 90+、Firefox 88+、Safari 14+
- **响应式设计**：编辑弹窗应适配不同屏幕尺寸
  - 桌面端（≥1280px）：弹窗宽度600px，最大高度80vh
  - 小屏幕（<1280px）：弹窗宽度90vw，最大高度90vh
- **性能要求**：弹窗打开速度 < 300ms，字段刷新延迟 < 200ms

### 6.2 功能边界
- **字段数量限制**：自定义字段最多支持20个，超过时提示"已达到字段数量上限"
- **字段类型支持**：仅支持文本、数值、单选下拉、多选下拉四种类型，不支持日期、文件上传等复杂类型
- **批量编辑限制**：一次最多批量编辑50个任务，超过时需要分批操作
- **历史记录**：暂不支持任务编辑历史记录和撤销功能（作为未来版本规划）

### 6.3 内容规范
- **字段名称规范**：
  - 长度：2-20个字符
  - 字符限制：支持中文、英文、数字、下划线
  - 唯一性：字段名称不能重复
- **字段值规范**：
  - 文本字段：最大长度200个字符
  - 数值字段：支持整数和小数，范围 -999999 ~ 999999
  - 下拉选项：每个选项最大长度50个字符，单个字段最多50个选项

### 6.4 技术约束
- **依赖库版本**：
  - DHTMLX Gantt：使用Edge版本（当前最新版）
  - SortableJS：1.15.0+
- **浏览器API**：使用localStorage存储字段配置（容量限制5MB）
- **样式系统**：基于CSS变量的设计系统，保持与现有DESIGN_SPEC.md规范一致
- **数据存储**：字段配置和任务数据存储在前端，暂不涉及后端API集成

### 6.5 用户体验约束
- **操作反馈时间**：
  - 即时反馈（<100ms）：按钮点击、输入框聚焦
  - 快速反馈（<300ms）：弹窗打开、面板滑出
  - 可接受延迟（<1s）：数据保存、配置导入导出
- **提示信息规范**：
  - 成功提示：绿色背景，2秒后自动消失
  - 错误提示：红色背景，需要用户手动关闭或修正错误
  - 警告提示：黄色背景，3秒后自动消失
- **无障碍访问**：
  - 所有按钮和链接支持键盘访问（Tab导航）
  - 表单元素有明确的label标签
  - 错误提示使用aria-live区域

## 7. 优先级说明

### P0（必须实现）
1. 动态高度的自定义字段区域（解决核心体验问题）
2. 保存操作反馈提示（提供操作确定性）
3. 字段验证机制（保证数据完整性）

### P1（重要功能）
4. 编辑弹窗内的字段管理入口（提升功能可发现性）
5. 任务条信息显示优化（减少视觉噪音）
6. 批量编辑功能（提升操作效率）

### P2（未来规划）
- 任务编辑历史记录
- 字段级权限控制（只读/可编辑）
- 自定义字段模板（预设常用字段组合）
- 字段条件显示（根据其他字段值动态显示/隐藏字段）

## 8. 成功指标

### 8.1 用户体验指标
- 任务编辑弹窗打开速度 < 300ms（95%的情况下）
- 用户无需滚动即可看到所有字段（字段数量≤6个的情况下）
- 保存成功率 > 99%（排除网络故障）

### 8.2 用户行为指标
- 字段管理功能使用率提升50%（相比右上角工具栏入口）
- 任务编辑操作时间减少30%（相比优化前）
- 批量编辑功能使用率 > 20%（占所有编辑操作的比例）

### 8.3 错误率指标
- 字段验证错误率 < 5%（占所有保存操作的比例）
- 用户因误操作删除字段的次数 < 1次/月（通过二次确认降低误操作）

## 9. 设计资源需求

### 9.1 UI设计需求
1. 任务编辑弹窗优化设计稿（包含各种字段数量的布局方案）
2. 字段管理面板设计稿（侧边栏样式）
3. 批量编辑弹窗设计稿
4. 各类提示信息的设计规范（成功/错误/警告）
5. 任务条信息显示优化方案（颜色标签、头像样式）

### 9.2 交互设计需求
1. 弹窗打开/关闭动画效果
2. 字段管理面板滑入/滑出动画
3. 字段验证错误的交互反馈
4. 批量选择任务的视觉反馈
5. 拖拽排序字段的交互效果

### 9.3 技术原型需求
1. 动态高度计算逻辑原型
2. 字段验证规则引擎原型
3. 批量编辑数据更新逻辑原型

## 10. 后续阶段说明

本文档为**需求分析阶段**输出的产品需求文档（PRD）。

**下一步工作**：
1. 设计师根据本PRD创建UI/UX设计稿
2. 评审设计稿，确认视觉和交互方案
3. 前端开发基于设计稿进行实现
4. 测试验证功能完整性和用户体验

**相关文档**：
- 待产出：《UI/UX设计稿-任务编辑页面优化》
- 待产出：《技术实现方案-任务编辑页面优化》
- 参考：`demo.html`（当前实现代码）
- 参考：`DESIGN_SPEC.md`（设计规范）
