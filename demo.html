        <!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æˆ‘çš„ç”˜ç‰¹å›¾ (æ–°è®¾è®¡)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <link href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css" rel="stylesheet">

    <style>
        /* 2. å®šä¹‰è®¾è®¡ç³»ç»Ÿå˜é‡ (æ¥è‡ª DESIGN_SPEC.md) */
        :root {
            /* 2.1 è‰²å½©ç³»ç»Ÿ */
            --primary-color: #4A90E2;
            --accent-color: #50E3C2;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --background-gray: #F9FAFB;
            --background-hover-gray: #F3F4F6;
            --background-white: #FFFFFF;
            --color-success: #22C55E;
            --color-warning: #F59E0B;
            --color-error: #EF4444;
            --task-bar-bg: #A5C8F1;

            /* 2.2 å­—ä½“è§„èŒƒ */
            --font-family-base: 'Inter', 'Source Han Sans CN', sans-serif;
            --font-size-body: 14px;
            --font-size-small: 12px;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;

            /* 2.3 å¸ƒå±€ç³»ç»Ÿ */
            --border-radius-small: 4px;
            --border-radius-medium: 8px;
            --shadow-standard: 0px 4px 6px -1px rgba(0, 0, 0, 0.1), 0px 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* å…¨å±€æ ·å¼ */
        html, body {
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
            font-family: var(--font-family-base);
            color: var(--text-primary);
            background-color: var(--background-gray);
        }

        #gantt_here {
            width: 100%;
            height: 100%;
        }

        /* 3. é‡å†™ dhtmlx-gantt ç»„ä»¶æ ·å¼ */

        /* å®¹å™¨å’Œè¾¹æ¡† */
        .gantt_container {
            border: none;
        }
        .gantt_grid, .gantt_task {
            border-top: 1px solid var(--border-color);
        }
        .gantt_grid_scale, .gantt_task_scale {
            background-color: var(--background-white);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        /* è¡¨æ ¼åŒºåŸŸ (Grid) */
        .gantt_grid_head_cell {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-body);
            color: var(--text-primary);
            cursor: move;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .gantt_grid_head_cell:hover {
            background-color: #F3F4F6;
            transform: translateY(-1px);
        }
        
        .gantt_grid_head_cell.drag-over {
            background-color: #E3F2FD;
            border: 2px dashed #4A90E2;
        }
        
        .gantt_grid_head_cell:not(.gantt_grid_head_cell_add)::after {
            content: 'â‹®â‹®';
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .gantt_grid_head_cell:not(.gantt_grid_head_cell_add):hover::after {
            opacity: 1;
        }
        .gantt_row {
            border-bottom: 1px solid var(--border-color);
        }
        .gantt_row:hover {
            background-color: var(--background-hover-gray);
        }
        .gantt_row.odd { /* ç§»é™¤æ–‘é©¬çº¹ */
            background-color: var(--background-white);
        }
        .gantt_grid_data .gantt_cell {
            font-size: var(--font-size-body);
            font-weight: var(--font-weight-regular);
        }
        .gantt_tree_content {
            font-weight: var(--font-weight-medium);
        }
        .gantt_grid_data {
            background-color: var(--background-white);
        }


        /* æ—¶é—´è½´ (Timeline) */
        .gantt_task_scale .gantt_scale_cell {
            font-size: var(--font-size-small);
            font-weight: var(--font-weight-regular);
        }
        .gantt_data_area {
             background-color: var(--background-white);
        }
        .gantt_task_row {
            border-bottom: 1px solid var(--border-color);
        }
        .gantt_task_row.odd {
             background-color: var(--background-white);
        }
        .weekend { /* æ ‡è®°å‘¨æœ« */
            background-color: var(--background-gray) !important;
        }

        /* ä»»åŠ¡æ¡ (Task Bar) */
        .gantt_task_line {
            background-color: var(--task-bar-bg);
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius-small);
        }
        .gantt_task_line:hover {
            box-shadow: var(--shadow-standard);
        }
        .gantt_task_progress {
            background-color: var(--accent-color);
            border-radius: var(--border-radius-small);
        }
        
        /* é€¾æœŸä»»åŠ¡æ¡æ ·å¼ */
        .gantt_task_line.task_overdue {
            background-color: var(--color-error);
            border-color: var(--color-error);
        }

        /* ä¾èµ–è¿çº¿ */
        .gantt_link_line {
            stroke: var(--primary-color);
            stroke-width: 1;
        }
        .gantt_link_arrow_right {
            border-left-color: var(--primary-color);
        }

        /* å­—æ®µç®¡ç†ç›¸å…³æ ·å¼ */
        .sortable-ghost {
            opacity: 0.4;
            background: var(--accent-color) !important;
        }

        .sortable-chosen {
            opacity: 0.8;
            background: #e3f2fd !important;
        }

        .sortable-drag {
            opacity: 1;
            background: white !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
        }

        .gantt_grid_head_cell {
            cursor: move !important;
            user-select: none;
        }

        .gantt_grid_head_cell:hover {
            background: var(--background-hover-gray) !important;
        }

        .sortable-field:hover {
            background: var(--background-hover-gray) !important;
        }
        
        /* å·¥å…·æ æŒ‰é’®æ‚¬åœæ•ˆæœ */
        #field-toolbar button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        /* å¼¹çª—åŠ¨ç”» */
        #field-config-modal, #field-sort-modal {
            transition: opacity 0.3s ease;
        }
        
        #field-config-modal > div, #field-sort-modal > div {
            transition: transform 0.3s ease;
        }

    </style>
</head>
<body>
    <div id="gantt_here"></div>

     <!-- å­—æ®µç®¡ç†å·¥å…·æ  -->
     <div id="field-toolbar" style="position: fixed; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
         <button id="add-field-btn" style="margin-right: 8px; padding: 6px 12px; background: #4A90E2; color: white; border: none; border-radius: 4px; cursor: pointer;">+ æ–°å¢å­—æ®µ</button>
         <button id="config-export-btn" style="margin-right: 8px; padding: 6px 12px; background: #22C55E; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ“¤ å¯¼å‡º</button>
         <button id="config-import-btn" style="padding: 6px 12px; background: #6B7280; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ“¥ å¯¼å…¥</button>
     </div>

    <!-- å­—æ®µé…ç½®å¼¹çª— -->
    <div id="field-config-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 8px; width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-top: 0; color: #1F2937;">å­—æ®µé…ç½®</h3>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">å­—æ®µåç§°ï¼š</label>
                <input type="text" id="field-name" style="width: 100%; padding: 8px; border: 1px solid #E5E7EB; border-radius: 4px; font-size: 14px;" placeholder="è¯·è¾“å…¥å­—æ®µåç§°">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">å­—æ®µç±»å‹ï¼š</label>
                <select id="field-type" style="width: 100%; padding: 8px; border: 1px solid #E5E7EB; border-radius: 4px; font-size: 14px;">
                    <option value="text">æ–‡æœ¬</option>
                    <option value="select">ä¸‹æ‹‰é€‰æ‹©ï¼ˆå•é€‰ï¼‰</option>
                    <option value="multiselect">ä¸‹æ‹‰é€‰æ‹©ï¼ˆå¤šé€‰ï¼‰</option>
                    <option value="number">æ•°å€¼</option>
                </select>
            </div>
            <div id="options-config" style="margin-bottom: 16px; display: none;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">é€‰é¡¹é…ç½®ï¼š</label>
                <div id="options-list"></div>
                <button id="add-option-btn" style="margin-top: 8px; padding: 6px 12px; background: #4A90E2; color: white; border: none; border-radius: 4px; cursor: pointer;">+ æ·»åŠ é€‰é¡¹</button>
            </div>
            <div style="text-align: right;">
                <button id="cancel-field-btn" style="margin-right: 8px; padding: 8px 16px; background: #6B7280; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                <button id="save-field-btn" style="padding: 8px 16px; background: #4A90E2; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜</button>
            </div>
        </div>
    </div>


    <!-- æ–‡ä»¶è¾“å…¥ï¼ˆç”¨äºå¯¼å…¥é…ç½®ï¼‰ -->
    <input type="file" id="config-file-input" style="display: none;" accept=".json">

    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <script src="https://cdn.dhtmlx.com/gantt/edge/locale/locale_cn.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* ä»Šå¤©æ ‡è®°çº¿æ ·å¼ - ä½¿ç”¨ CSS ä¼ªå…ƒç´ åˆ›å»º */
        .gantt_data_area::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--primary-color);
            z-index: 10;
            left: calc(var(--today-position, 50%) * 1px);
            pointer-events: none;
        }
    </style>
    <script>
        // å­—æ®µç®¡ç†ç›¸å…³å˜é‡
        let customFields = [
            {name: "priority", label: "ä¼˜å…ˆçº§", type: "select", options: ["é«˜", "ä¸­", "ä½"], width: 80},
            {name: "assignee", label: "è´Ÿè´£äºº", type: "text", width: 100},
            {name: "status", label: "çŠ¶æ€", type: "select", options: ["å¾…å¼€å§‹", "è¿›è¡Œä¸­", "å·²å®Œæˆ", "å·²æš‚åœ"], width: 100}
        ];
        let fieldOrder = ["text", "priority", "assignee", "status", "start_date", "duration", "progress"];
        let sortableInstance = null;

        // 1. å®šä¹‰ç”˜ç‰¹å›¾çš„åˆ—ï¼ˆæ”¯æŒåŠ¨æ€é…ç½®ï¼‰
        function updateGanttColumns() {
            const columns = [];
            
            // æŒ‰ç…§å­—æ®µé¡ºåºæ·»åŠ åˆ—
            fieldOrder.forEach(fieldName => {
                if (fieldName === "text") {
                    columns.push({name: "text", label: "ä»»åŠ¡åç§°", tree: true, width: 200, resize: true});
                } else if (fieldName === "start_date") {
                    columns.push({name: "start_date", label: "å¼€å§‹æ—¶é—´", align: "center", width: 90, resize: true});
                } else if (fieldName === "duration") {
                    columns.push({name: "duration", label: "å·¥æœŸ(å¤©)", align: "center", width: 80, resize: true});
                } else if (fieldName === "progress") {
                    columns.push({name: "progress", label: "è¿›åº¦(%)", align: "center", width: 80, resize: true,
                        template: function (task) {
                            return Math.round(task.progress * 100) + "%";
                        }
                    });
                } else {
                    // è‡ªå®šä¹‰å­—æ®µ
                    const customField = customFields.find(f => f.name === fieldName);
                    if (customField) {
                        columns.push({
                            name: fieldName,
                            label: customField.label,
                            align: "center",
                            width: customField.width || 100,
                            resize: true,
                            template: function(task) {
                                return task[fieldName] || '';
                            }
                        });
                    }
                }
            });
            
            // æ·»åŠ æ“ä½œåˆ—
            columns.push({name: "add", label: "", width: 44});
            
             gantt.config.columns = columns;
             
             // æ¸²æŸ“ç”˜ç‰¹å›¾
             // æ³¨æ„ï¼šå¦‚æœæ˜¯åˆå§‹åŒ–é˜¶æ®µï¼Œinitä¼šè§¦å‘æ¸²æŸ“ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤æ¸²æŸ“
             // å¦‚æœæ˜¯åç»­æ›´æ–°ï¼Œrenderä¼šé‡æ–°ç»˜åˆ¶
             if (gantt.$container) {
                 gantt.render();
                 // é‡æ–°åˆå§‹åŒ– Sortable å’Œ Resizer
                 initColumnSortable();
                 initResizer();
             }
        }

        // ä½¿ç”¨ SortableJS åˆå§‹åŒ–åˆ—æ‹–æ‹½
        function initColumnSortable() {
             // ç¡®ä¿æ¸…ç†æ—§å®ä¾‹
             if (sortableInstance) {
                 sortableInstance.destroy();
                 sortableInstance = null;
             }

             // å°è¯•å¤šç§é€‰æ‹©å™¨æ‰¾åˆ°è¡¨å¤´å®¹å™¨
             let gridHeader = document.querySelector('.gantt_grid_head');

             // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•å…¶ä»–é€‰æ‹©å™¨
             if (!gridHeader) {
                 gridHeader = document.querySelector('.gantt_grid_scale');
             }

             if (!gridHeader) {
                 // æ‰“å°å½“å‰ DOM ç»“æ„å¸®åŠ©è°ƒè¯•
                 console.warn('æœªæ‰¾åˆ°è¡¨å¤´å…ƒç´ ï¼Œå½“å‰ gantt å®¹å™¨å†…å®¹:');
                 const ganttContainer = document.querySelector('#gantt_here');
                 if (ganttContainer) {
                     console.log('gantt_here å­å…ƒç´ :', ganttContainer.innerHTML.substring(0, 500));
                 }
                 return;
             }

             console.log('æ‰¾åˆ°è¡¨å¤´å…ƒç´ :', gridHeader.className);
             console.log('è¡¨å¤´å­å…ƒç´ æ•°é‡:', gridHeader.children.length);

             sortableInstance = new Sortable(gridHeader, {
                 animation: 150,
                 filter: '.gantt_grid_head_cell_add, .gantt_last_cell', // å¿½ç•¥æ“ä½œåˆ—
                 draggable: '.gantt_grid_head_cell', // åªæœ‰è¿™äº›å…ƒç´ å¯ä»¥è¢«æ‹–æ‹½
                 ghostClass: 'sortable-ghost',
                 chosenClass: 'sortable-chosen',
                 dragClass: 'sortable-drag',
                 forceFallback: true, // å¼ºåˆ¶ä½¿ç”¨ fallback æ¨¡å¼ï¼Œæ›´å…¼å®¹
                 fallbackClass: 'sortable-fallback',
                 onStart: function(evt) {
                     console.log('å¼€å§‹æ‹–æ‹½åˆ—:', evt.oldIndex);
                 },
                 onEnd: function (evt) {
                     const oldIndex = evt.oldIndex;
                     const newIndex = evt.newIndex;

                     console.log('æ‹–æ‹½ç»“æŸ - ä»', oldIndex, 'åˆ°', newIndex);

                     if (newIndex === oldIndex) return;

                     // æ£€æŸ¥æ˜¯å¦æ‹–æ‹½åˆ°äº†"æ“ä½œåˆ—"ä¹‹å
                     // fieldOrder é•¿åº¦æ¯” columns å°‘ 1 (ä¸åŒ…å« add åˆ—)
                     if (newIndex >= fieldOrder.length) {
                         console.log('æ‹–åˆ°äº†æ“ä½œåˆ—åé¢ï¼Œæ¢å¤åŸçŠ¶');
                         updateGanttColumns();
                         return;
                     }

                     // æ›´æ–° fieldOrder
                     const movedField = fieldOrder.splice(oldIndex, 1)[0];
                     fieldOrder.splice(newIndex, 0, movedField);

                     console.log('æ–°çš„å­—æ®µé¡ºåº:', fieldOrder);

                     // è§¦å‘æ›´æ–°
                     updateGanttColumns();
                 }
             });

             console.log('Sortable åˆå§‹åŒ–æˆåŠŸï¼Œå¯æ‹–æ‹½å…ƒç´ æ•°é‡:', gridHeader.querySelectorAll('.gantt_grid_head_cell').length);
        }

        // åˆå§‹åŒ–è‡ªå®šä¹‰ Resizer
        function initResizer() {
            const resizer = document.getElementById("custom-resizer");
            if (!resizer) return;
            
            // é¿å…é‡å¤ç»‘å®š
            if (resizer._isInitialized) return;
            resizer._isInitialized = true;
            
            resizer.onmousedown = function(e) {
                e.preventDefault();
                const startX = e.clientX;
                const colConfig = gantt.config.layout.cols[0];
                const startWidth = colConfig.width || 400;
                
                function onMouseMove(e) {
                    const diff = e.clientX - startX;
                    let newWidth = startWidth + diff;
                    if (newWidth < 200) newWidth = 200;
                    
                    // æ›´æ–° Layout é…ç½®å¹¶é‡ç»˜
                    colConfig.width = newWidth;
                    gantt.resetLayout();
                }
                
                function onMouseUp() {
                    document.removeEventListener("mousemove", onMouseMove);
                    document.removeEventListener("mouseup", onMouseUp);

                    // ä¿å­˜å½“å‰å®½åº¦åˆ° localStorage
                    try {
                        localStorage.setItem('gantt_grid_width', colConfig.width);
                    } catch (e) {
                        console.warn('æ— æ³•ä¿å­˜å®½åº¦è®¾ç½®:', e);
                    }

                    // é‡ç»˜åéœ€è¦é‡æ–°ç»‘å®šäº‹ä»¶
                    initResizer();
                    initColumnSortable();
                }
                
                document.addEventListener("mousemove", onMouseMove);
                document.addEventListener("mouseup", onMouseUp);
            };
        }

        // ä» localStorage æ¢å¤å·¦ä¾§å®½åº¦è®¾ç½®
        let savedGridWidth = 400; // é»˜è®¤å®½åº¦
        try {
            const saved = localStorage.getItem('gantt_grid_width');
            if (saved) {
                savedGridWidth = parseInt(saved, 10);
                if (savedGridWidth < 200) savedGridWidth = 200; // æœ€å°å®½åº¦é™åˆ¶
            }
        } catch (e) {
            console.warn('æ— æ³•è¯»å–å®½åº¦è®¾ç½®:', e);
        }

        // é…ç½® DHTMLX Native Layout
        // ä½¿ç”¨è‡ªå®šä¹‰ HTML å…ƒç´ ä½œä¸º Resizerï¼Œä»¥å…¼å®¹ Standard ç‰ˆæœ¬
        gantt.config.layout = {
            css: "gantt_container",
            cols: [
                {
                    width: savedGridWidth, // ä½¿ç”¨ä¿å­˜çš„å®½åº¦
                    min_width: 200,
                    rows:[
                        {view: "grid", scrollX: "gridScroll", scrollY: "scrollVer"},
                        {view: "scrollbar", id: "gridScroll", group:"horizontal"}
                    ]
                },
                {
                    width: 4,
                    html: "<div id='custom-resizer' style='width:100%;height:100%;background:#E5E7EB;cursor:col-resize;border-left:1px solid #D1D5DB;border-right:1px solid #D1D5DB;'></div>"
                },
                {
                    rows:[
                        {view: "timeline", scrollX: "scrollHor", scrollY: "scrollVer"},
                        {view: "scrollbar", id: "scrollHor", group:"horizontal"}
                    ]
                },
                {view: "scrollbar", id: "scrollVer"}
            ]
        };

        // åˆå§‹åŒ–åˆ—é…ç½®
        updateGanttColumns();

        // 2. å…ˆè®¾ç½®ä¸­æ–‡è¯­è¨€
        gantt.i18n.setLocale("cn");

        // 3. ä½¿ç”¨ scales é…ç½®æ›¿ä»£æ—§çš„ scale_unit/date_scale/subscalesï¼ˆæ›´å¯é ï¼‰
        gantt.config.scales = [
            {
                unit: "month",
                step: 1,
                format: function(date) {
                    return date.getFullYear() + "å¹´" + (date.getMonth() + 1) + "æœˆ";
                }
            },
            {
                unit: "day",
                step: 1,
                format: function(date) {
                    return (date.getMonth() + 1) + "æœˆ" + date.getDate() + "æ—¥";
                },
                css: function(date) {
                    if (date.getDay() === 0 || date.getDay() === 6) {
                        return "weekend";
                    }
                    return "";
                }
            }
        ];

        // 4. å¢åŠ  JS é€»è¾‘ä»¥å®ç°è®¾è®¡è§„èŒƒä¸­çš„åŠ¨æ€æ ·å¼
        // 4.1 è®¡ç®—ä»Šå¤©çš„ä½ç½®å¹¶è®¾ç½® CSS å˜é‡
        var today = new Date();
        gantt.attachEvent("onGanttReady", function() {
            var todayPosition = gantt.posFromDate(today);
            document.documentElement.style.setProperty('--today-position', todayPosition + 'px');
        });

        // 4.2 å®šä¹‰ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œç”¨äºç»™é€¾æœŸä»»åŠ¡æ·»åŠ è‡ªå®šä¹‰ CSS ç±»
        gantt.templates.task_class = function (start, end, task) {
            if (task.progress < 1 && new Date() > end) {
                return "task_overdue";
            }
            return "";
        };

        // 4.3 è‡ªå®šä¹‰ä»»åŠ¡æ¡æ¨¡æ¿ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰å­—æ®µä¿¡æ¯
        gantt.templates.task_text = function(start, end, task) {
            let text = task.text;
            
            // æ·»åŠ è‡ªå®šä¹‰å­—æ®µä¿¡æ¯
            customFields.forEach(field => {
                const value = task[field.name];
                if (value) {
                    if (field.type === 'multiselect') {
                        const values = value.split(',').join(', ');
                        text += `<br><small style="color: #666; font-size: 11px;">${field.label}: ${values}</small>`;
                    } else {
                        text += `<br><small style="color: #666; font-size: 11px;">${field.label}: ${value}</small>`;
                    }
                }
            });
            
            return text;
        };

         // 5. é…ç½®lightboxï¼ˆç¼–è¾‘å¼¹çª—ï¼‰æ”¯æŒè‡ªå®šä¹‰å­—æ®µ
        // ä½¿ç”¨form_blocksæ³¨å†Œè‡ªå®šä¹‰æ¨¡æ¿åŒºå—
        gantt.form_blocks["custom_fields"] = {
            render: function(sns) {
                return "<div class='gantt_cal_ltext gantt_custom_fields_container' style='height:" + sns.height + "px;'></div>";
            },
            set_value: function(node, value, task, section) {
                // ç”Ÿæˆè‡ªå®šä¹‰å­—æ®µçš„HTML
                let html = '<div class="custom-fields-section" style="padding: 10px; height: 100%; overflow-y: auto;">';
                html += '<h4 style="margin: 0 0 15px 0; color: #1F2937; font-size: 14px; font-weight: 600;">è‡ªå®šä¹‰å­—æ®µ</h4>';

                customFields.forEach(field => {
                    const fieldValue = task[field.name] || '';
                    html += `<div class="custom-field-item" style="margin-bottom: 15px;">`;
                    html += `<label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151; font-size: 13px;">${field.label}:</label>`;

                    if (field.type === 'text') {
                        html += `<input type="text" name="${field.name}" value="${fieldValue}" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 13px; box-sizing: border-box;">`;
                    } else if (field.type === 'number') {
                        html += `<input type="number" name="${field.name}" value="${fieldValue}" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 13px; box-sizing: border-box;">`;
                    } else if (field.type === 'select') {
                        html += `<select name="${field.name}" style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 13px; box-sizing: border-box;">`;
                        html += `<option value="">è¯·é€‰æ‹©</option>`;
                        field.options.forEach(option => {
                            const selected = fieldValue === option ? 'selected' : '';
                            html += `<option value="${option}" ${selected}>${option}</option>`;
                        });
                        html += `</select>`;
                    } else if (field.type === 'multiselect') {
                        const selectedValues = Array.isArray(fieldValue) ? fieldValue : (fieldValue ? fieldValue.split(',') : []);
                        html += `<select name="${field.name}" multiple style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 4px; height: 80px; font-size: 13px; box-sizing: border-box;">`;
                        field.options.forEach(option => {
                            const selected = selectedValues.includes(option) ? 'selected' : '';
                            html += `<option value="${option}" ${selected}>${option}</option>`;
                        });
                        html += `</select>`;
                    }
                    html += `</div>`;
                });
                html += '</div>';

                node.innerHTML = html;
            },
            get_value: function(node, task, section) {
                // ä»è¾“å…¥æ¡†ä¸­è¯»å–å€¼å¹¶ä¿å­˜åˆ°taskå¯¹è±¡
                customFields.forEach(field => {
                    const input = node.querySelector(`input[name="${field.name}"], select[name="${field.name}"]`);
                    if (input) {
                        if (field.type === 'multiselect') {
                            const selectedOptions = Array.from(input.selectedOptions).map(option => option.value);
                            task[field.name] = selectedOptions.join(',');
                        } else {
                            task[field.name] = input.value;
                        }
                    }
                });
                return task.custom_fields; // è¿”å›å€¼ç”¨äºmap_toå­—æ®µ
            },
            focus: function(node) {
                // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
                const firstInput = node.querySelector('input, select');
                if (firstInput) firstInput.focus();
            }
        };

        gantt.config.lightbox.sections = [
            {name: "description", height: 70, map_to: "text", type: "textarea", focus: true},
            {name: "time", height: 72, type: "duration", map_to: "auto"},
            {name: "custom_fields", height: 200, type: "custom_fields", map_to: "custom_fields"}
        ];

        // åˆ·æ–°Lightboxé…ç½®(ç”¨äºæ–°å¢å­—æ®µåç«‹å³ç”Ÿæ•ˆ)
        function refreshLightbox() {
            // å¦‚æœå½“å‰æœ‰æ‰“å¼€çš„lightbox,å…ˆå…³é—­
            if (gantt.getLightbox()) {
                gantt.hideLightbox();
            }

            // åˆ é™¤ç°æœ‰çš„lightbox HTMLå…ƒç´ (å¼ºåˆ¶é‡å»º)
            const existingLightbox = document.querySelector('.gantt_cal_light');
            if (existingLightbox) {
                existingLightbox.remove();
            }

            // é‡æ–°é…ç½®sections
            gantt.config.lightbox.sections = [
                {name: "description", height: 70, map_to: "text", type: "textarea", focus: true},
                {name: "time", height: 72, type: "duration", map_to: "auto"},
                {name: "custom_fields", height: 200, type: "custom_fields", map_to: "custom_fields"}
            ];

            // æ¸…é™¤å†…éƒ¨lightboxç¼“å­˜
            gantt._lightbox = null;
        }

        // ç›‘å¬ Gantt Ready äº‹ä»¶æ¥åˆå§‹åŒ– Resizer
        gantt.attachEvent("onGanttReady", function() {
            initResizer();
        });

        // 6. åˆå§‹åŒ–ç”˜ç‰¹å›¾
        gantt.init("gantt_here");

        // 6. å®šä¹‰ç¤ºä¾‹æ•°æ® (ä¸åŸæ–‡ä»¶ä¸€è‡´)
        var tasks = {
            data: [
                {id: 1, text: "é¡¹ç›® #1", start_date: "2025-10-01", duration: 18, progress: 0.4, open: true, priority: "é«˜", assignee: "å¼ ä¸‰", status: "è¿›è¡Œä¸­"},
                {id: 2, text: "ä»»åŠ¡ #1", start_date: "2025-10-02", duration: 8, progress: 0.6, parent: 1, priority: "ä¸­", assignee: "æå››", status: "è¿›è¡Œä¸­"},
                {id: 3, text: "ä»»åŠ¡ #2", start_date: "2025-10-11", duration: 8, progress: 0.2, parent: 1, priority: "ä½", assignee: "ç‹äº”", status: "å¾…å¼€å§‹"}
            ],
            links: [
                {id: 1, source: 2, target: 3, type: "0"}
            ]
        };

        // 7. åŠ è½½æ•°æ®åˆ°ç”˜ç‰¹å›¾
        gantt.parse(tasks);

        // 8. åœ¨æ•°æ®å®Œå…¨åŠ è½½ååˆå§‹åŒ–åˆ—æ‹–æ‹½ï¼ˆä½¿ç”¨è¾ƒé•¿å»¶è¿Ÿç¡®ä¿ DOM ç¨³å®šï¼‰
        setTimeout(function() {
            initColumnSortable();
            console.log('é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– Sortable');
        }, 500);

        // 8. å­—æ®µç®¡ç†åŠŸèƒ½å®ç°
        document.addEventListener('DOMContentLoaded', function() {
            // æ–°å¢å­—æ®µæŒ‰é’®
            document.getElementById('add-field-btn').addEventListener('click', function() {
                document.getElementById('field-config-modal').style.display = 'block';
                document.getElementById('field-name').value = '';
                document.getElementById('field-type').value = 'text';
                document.getElementById('options-config').style.display = 'none';
                document.getElementById('options-list').innerHTML = '';
            });

            // å­—æ®µç±»å‹å˜åŒ–
            document.getElementById('field-type').addEventListener('change', function() {
                const type = this.value;
                const optionsConfig = document.getElementById('options-config');
                if (type === 'select' || type === 'multiselect') {
                    optionsConfig.style.display = 'block';
                } else {
                    optionsConfig.style.display = 'none';
                }
            });

            // æ·»åŠ é€‰é¡¹æŒ‰é’®
            document.getElementById('add-option-btn').addEventListener('click', function() {
                const optionsList = document.getElementById('options-list');
                const optionDiv = document.createElement('div');
                optionDiv.style.marginBottom = '8px';
                optionDiv.innerHTML = `
                    <input type="text" placeholder="é€‰é¡¹å€¼" style="width: 70%; padding: 6px; border: 1px solid #E5E7EB; border-radius: 4px; margin-right: 8px;">
                    <button type="button" onclick="this.parentElement.remove()" style="padding: 6px 12px; background: #EF4444; color: white; border: none; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
                `;
                optionsList.appendChild(optionDiv);
            });

            // ä¿å­˜å­—æ®µé…ç½®
            document.getElementById('save-field-btn').addEventListener('click', function() {
                const fieldName = document.getElementById('field-name').value.trim();
                const fieldType = document.getElementById('field-type').value;
                
                if (!fieldName) {
                    alert('è¯·è¾“å…¥å­—æ®µåç§°');
                    return;
                }

                const fieldConfig = {
                    name: fieldName.toLowerCase().replace(/\s+/g, '_'),
                    label: fieldName,
                    type: fieldType,
                    width: 100
                };

                if (fieldType === 'select' || fieldType === 'multiselect') {
                    const options = [];
                    document.querySelectorAll('#options-list input[type="text"]').forEach(input => {
                        if (input.value.trim()) {
                            options.push(input.value.trim());
                        }
                    });
                    fieldConfig.options = options;
                }

                customFields.push(fieldConfig);
                fieldOrder.push(fieldConfig.name);
                updateGanttColumns();
                refreshLightbox(); // åˆ·æ–°Lightboxé…ç½®

                document.getElementById('field-config-modal').style.display = 'none';
            });

            // å–æ¶ˆå­—æ®µé…ç½®
            document.getElementById('cancel-field-btn').addEventListener('click', function() {
                document.getElementById('field-config-modal').style.display = 'none';
            });


            // å¯¼å‡ºé…ç½®
            document.getElementById('config-export-btn').addEventListener('click', function() {
                const config = {
                    customFields: customFields,
                    fieldOrder: fieldOrder,
                    exportTime: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'gantt-fields-config.json';
                a.click();
                URL.revokeObjectURL(url);
            });

            // å¯¼å…¥é…ç½®
            document.getElementById('config-import-btn').addEventListener('click', function() {
                document.getElementById('config-file-input').click();
            });

            document.getElementById('config-file-input').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        if (config.customFields && config.fieldOrder) {
                            customFields = config.customFields;
                            fieldOrder = config.fieldOrder;
                            updateGanttColumns();
                            refreshLightbox(); // åˆ·æ–°Lightboxé…ç½®
                            alert('é…ç½®å¯¼å…¥æˆåŠŸï¼');
                        } else {
                            alert('é…ç½®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                        }
                    } catch (error) {
                        alert('é…ç½®æ–‡ä»¶è§£æå¤±è´¥ï¼š' + error.message);
                    }
                };
                reader.readAsText(file);
            });
        });
    </script>
</body>
</html>