# 需求文档（Product Requirements Document）

## 1. 概述
- **名称**：甘特图工具栏优化与国际化
- **定位**：提升工具栏UI美观度，增加多语言支持，优化Excel导出功能，修复用户体验Bug
- **目标用户**：项目经理、产品经理、开发团队、国际用户
- **核心问题**：
  1. 工具栏样式与设计规范不符
  2. 缺乏多语言支持，国际用户体验差
  3. 快捷键面板默认展开占用空间
  4. Excel导出下拉字段缺少数据验证
  5. 新增任务关闭时异常提示不消失

---

## 2. 需求列表

### 2.1 快捷键及图例默认隐藏

| 项目 | 内容 |
|------|------|
| **优先级** | P1 |
| **需求描述** | 快捷键和图例面板默认折叠状态，用户点击展开 |
| **验收标准** | ✅ 页面加载时面板默认折叠<br>✅ 点击标题可展开/折叠<br>✅ 状态在刷新后重置为折叠 |

---

### 2.2 操作栏样式UI优化

| 项目 | 内容 |
|------|------|
| **优先级** | P0 |
| **需求描述** | 按照Figma设计稿优化工具栏样式，"编辑模式"改名为"批量编辑"，主要调整操作栏的布局，有些U不存在的功能可以忽略 |
| **设计链接** | [Figma Node 19:33](https://www.figma.com/design/ek42llm5nwsJsfJYjH39sY/%E7%94%98%E7%89%B9%E5%9B%BE?node-id=19-33&m=dev) |

#### 设计规范（基于Figma）

**整体布局**：
```
┌────────────────────────────────────────────────────────────────┐
│ [日视图 ▼]  [◀] [Today] [▶]  │  🔍 Search tasks...  │ 图标组 │ More │ + New Task │
└────────────────────────────────────────────────────────────────┘
```

**左侧区域**：
- 视图选择器：圆角下拉框，背景 `rgba(236,236,240,0.3)`，边框 `rgba(0,0,0,0.1)`
- 日期导航：左右箭头按钮 + "Today" 文字按钮

**中间区域**：
- 搜索框：300px宽度，圆角32px，左侧搜索图标，placeholder "Search tasks..."

**右侧区域**：
- 图标按钮组：筛选、导出、设置（32x32px）
- 分隔线
- "More" 二级菜单按钮
- "New Task" 主按钮：紫色背景，白色文字

**按钮命名调整**：
| 旧名称 | 新名称 |
|--------|--------|
| 编辑模式 | 批量编辑 |

---

### 2.3 语言选择及国际化

| 项目 | 内容 |
|------|------|
| **优先级** | P1 |
| **需求描述** | 支持多语言切换，自动检测用户浏览器语言 |
| **验收标准** | ✅ 支持中文、英语、日语、韩语<br>✅ 语言切换放在"更多"菜单中<br>✅ 所有UI文本实现国际化<br>✅ 日期时间格式本地化<br>✅ 无匹配语言时默认英语 |

#### 支持语言列表

| 语言代码 | 语言名称 | 日期格式 | 时间格式 |
|----------|----------|----------|----------|
| zh-CN | 简体中文 | YYYY年MM月DD日 | HH:mm |
| en-US | English | MM/DD/YYYY | hh:mm A |
| ja-JP | 日本語 | YYYY年MM月DD日 | HH:mm |
| ko-KR | 한국어 | YYYY년 MM월 DD일 | HH:mm |

#### 需要国际化的内容

1. **按钮文本**：编辑字段、批量编辑、今天、更多、新建任务等
2. **菜单项**：视图切换、导出Excel、导入Excel、导出JSON、导入JSON
3. **表单标签**：任务名称、开始时间、工期、进度、父任务等
4. **提示消息**：成功/错误Toast、校验提示
5. **占位符文本**：搜索框、输入框
6. **日期时间**：甘特图时间轴、日期选择器

---

### 2.4 Excel导出优化 - 下拉字段数据验证

| 项目 | 内容 |
|------|------|
| **优先级** | P1 |
| **需求描述** | 导出Excel时，下拉字段（select/multiselect）添加Excel数据验证 |
| **验收标准** | ✅ 下拉字段单元格有下拉列表<br>✅ 多选字段显示所有选项<br>✅ 导出字段顺序与列表一致，名称也要和表格中展示的一致<br>✅ 自定义字段完整导出 <br>✅ 换一种语言后也可以正常导入，字段名需要与对应语言的一致|

#### 技术方案

使用 xlsx 库的数据验证功能：
```javascript
// 设置下拉列表验证
ws['!dataValidation'] = [{
  type: 'list',
  sqref: 'G2:G100', // 应用范围
  formula1: '"选项1,选项2,选项3"' // 下拉选项
}];
```

---

### 2.5 Excel导入适配

| 项目 | 内容 |
|------|------|
| **优先级** | P1 |
| **需求描述** | 导入逻辑适配导出的变更，保持格式一致 |
| **验收标准** | ✅ 支持读取带数据验证的Excel<br>✅ 自定义字段按列顺序正确映射<br>✅ 错误提示国际化 |

---

## 3. Bug修复

### 3.1 新增任务关闭时必填校验问题

| 项目 | 内容 |
|------|------|
| **优先级** | P0 |
| **问题描述** | 新增任务弹窗，点击X关闭后触发必填校验并显示"此字段必填"提示 |
| **期望行为** | 点击X关闭时直接关闭弹窗，不触发校验；只在点击"保存"时校验 |

**根因分析**：
- dhtmlxGantt lightbox关闭事件可能触发了表单验证
- 需要区分"取消/关闭"和"保存"操作

**修复方案**：
```javascript
// 在关闭事件中区分操作类型
gantt.attachEvent("onLightboxCancel", function(id){
    // 跳过校验，直接关闭
    return true; 
});
```

---

### 3.2 异常提示不自动消失

| 项目 | 内容 |
|------|------|
| **优先级** | P0 |
| **问题描述** | 新增任务后直接关闭时抛出异常提示，该提示一直显示不消失 |
| **期望行为** | 错误提示3秒后自动消失 |

**根因分析**：
- 可能是 `showToast` 被调用时传入了 `duration=0`
- 或者是其他地方创建了不带自动关闭的toast

**修复方案**：
1. 排查所有 `showToast` 调用，确保未传入 `duration=0`
2. 增加最大显示时长限制作为保底

---

## 4. 页面架构

### 4.1 文件变更清单

| 文件路径 | 变更类型 | 说明 |
|----------|----------|------|
| `index.html` | 修改 | 调整工具栏HTML结构，添加语言选择器 |
| `src/styles/components/toolbar.css` | 修改 | 按Figma设计稿优化样式 |
| `src/styles/components/shortcuts-panel.css` | 修改 | 默认折叠状态 |
| `src/features/config/configIO.js` | 修改 | Excel导出添加数据验证 |
| `src/features/lightbox/customization.js` | 修改 | 修复关闭校验问题 |
| `src/utils/toast.js` | 修改 | 增加最大时长保底 |
| `src/locales/` | 新增 | 国际化语言包 |
| `src/locales/zh-CN.js` | 新增 | 中文语言包 |
| `src/locales/en-US.js` | 新增 | 英文语言包 |
| `src/locales/ja-JP.js` | 新增 | 日文语言包 |
| `src/locales/ko-KR.js` | 新增 | 韩文语言包 |
| `src/utils/i18n.js` | 新增 | 国际化工具类 |

---

## 5. 用户故事

### P0核心功能：
- 作为**项目经理**，我希望**工具栏样式更美观专业**，以便**给团队和客户留下好印象**
- 作为**用户**，我希望**关闭新建任务弹窗时不报错**，以便**流畅地使用产品**

### P1重要功能：
- 作为**国际用户**，我希望**使用我熟悉的语言和日期格式**，以便**更高效地管理项目**
- 作为**数据分析师**，我希望**导出的Excel下拉字段有数据验证**，以便**减少数据输入错误**
- 作为**用户**，我希望**快捷键面板默认隐藏**，以便**有更多空间查看甘特图**

---

## 6. 约束

- **平台要求**：现代浏览器（Chrome 80+, Firefox 75+, Safari 13+, Edge 80+）
- **功能边界**：
  - 暂不调整Excel导出的任务ID/父任务ID列
  - 语言切换持久化（刷新后保持切换后的语言）
- **技术约束**：
  - 使用 xlsx 库实现Excel数据验证
  - dhtmlxGantt 支持多语言切换

---

## 7. 验收标准总览

| 需求 | 验收方法 |
|------|----------|
| 快捷键默认隐藏 | 页面加载后检查面板状态 |
| 工具栏UI优化 | 与Figma设计稿对比 |
| 国际化 | 切换4种语言验证UI变化 |
| Excel数据验证 | 导出Excel检查下拉列表 |
| 关闭校验Bug | 新建任务后点X关闭不报错 |
| Toast消失Bug | 触发错误提示后3秒内消失 |

---

## 8. 相关文档

- 设计规范: [DESIGN_SPEC_全局.md](file:///c:/Users/24408/Desktop/新建文件夹/doc/design/DESIGN_SPEC_全局.md)
- 已完成PRD: [PRD-甘特图UX优化-已完成.md](file:///c:/Users/24408/Desktop/新建文件夹/doc/prd/PRD-甘特图UX优化-已完成.md)
