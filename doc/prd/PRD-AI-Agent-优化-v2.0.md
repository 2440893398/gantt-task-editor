# 产品需求文档 (PRD): AI Agent 交互优化 v2.0

> **关联需求**: [PRD-AI-Agent-架构.md](./PRD-AI-Agent-架构.md)  
> **需求来源**: [变更记录](../root/1.md)  
> **版本**: v2.0  
> **创建日期**: 2026-01-18  
> **状态**: 待评审

---

## 1. 版本概述

本需求基于 AI Agent 架构 v1.0 版本，针对用户体验和交互细节进行优化升级。主要聚焦于：
- AI 配置界面的可用性提升
- AI 交互流程的透明化与可控性
- 错误处理与用户反馈优化
- 任务编辑功能增强

## 2. 需求清单

### 2.1 AI 设置页面优化

| 需求编号 | 需求名称 | 优先级 | 依赖 |
|:--------:|:--------:|:------:|:----:|
| F-101 | AI 设置页面样式优化 | P0 | - |
| F-102 | 模型下拉选择框优化 | P0 | - |
| F-103 | 模型列表刷新功能 | P1 | F-102 |

#### F-101 AI 设置页面样式优化
- **描述**: 优化 AI 配置界面的整体视觉效果和布局
- **验收标准**:
  - 布局清晰、层次分明
  - 符合全局设计规范
  - 移动端适配良好

#### F-102 模型下拉选择框优化
- **描述**: 改进模型选择器的交互体验，支持下拉选择与手动输入双模式
- **交互模式**:
  - **下拉选择**: 从已获取的模型列表中选择
  - **手动输入**: 用户可直接录入任意模型名称（适用于列表未包含的模型）
- **验收标准**:
  - 下拉框支持搜索过滤
  - 显示模型完整名称和描述（如有）
  - 支持分组展示（按厂商/能力分类）**[可选]**
  - 支持自由文本输入，输入框可编辑

#### F-103 模型列表刷新功能
- **描述**: 新增刷新按钮，点击后调用 OpenAI 兼容接口 (`/v1/models`) 获取最新模型列表
- **验收标准**:
  - 刷新按钮位于模型选择器右侧
  - 点击后显示加载状态
  - 成功后更新模型列表，失败后显示错误提示
  - 缓存机制：成功获取后缓存至本地，避免频繁请求

---

### 2.2 错误处理优化

| 需求编号 | 需求名称 | 优先级 | 依赖 |
|:--------:|:--------:|:------:|:----:|
| F-104 | 智能错误提示 | P0 | - |

#### F-104 智能错误提示
- **描述**: 对 AI 接口返回的错误信息进行友好解析和展示
- **错误类型映射**:

| 错误类型 | 用户提示 | 建议操作 |
|:---------|:---------|:---------|
| `quota_exceeded` / 免费额度用尽 | "当前模型免费额度已用完" | 引导切换付费模型或充值 |
| `invalid_api_key` | "API Key 无效" | 引导检查配置 |
| `rate_limit_exceeded` | "请求过于频繁" | 提示稍后再试 |
| `model_not_found` | "模型不存在" | 引导选择其他模型 |
| `network_error` | "网络连接失败" | 检查网络或 Base URL |

- **验收标准**:
  - 错误信息以 Toast 或 Alert 形式展示
  - 包含错误原因和建议操作
  - 支持点击查看原始错误详情（可折叠）

---

### 2.3 AI 交互侧边栏优化

| 需求编号 | 需求名称 | 优先级 | 依赖 |
|:--------:|:--------:|:------:|:----:|
| F-105 | 侧边栏样式优化 | P0 | - |
| F-106 | 多轮对话交互 | P1 | F-105 |
| F-107 | 结果 JSON 结构化呈现 | P0 | - |
| F-108 | 优化结果应用/撤回 | P0 | F-107 |

#### F-105 侧边栏样式优化
- **描述**: 优化 AI 交互侧边栏的视觉效果，参考成熟产品设计
- **参考对标**: Cursor、GitHub Copilot Chat、Claude Web
- **验收标准**:
  - 侧边栏宽度可调节
  - 消息气泡样式区分用户/AI
  - 支持代码块语法高亮
  - Markdown 渲染支持

#### F-106 多轮对话交互
- **描述**: 允许用户与 AI 进行多轮对话，逐步优化结果
- **验收标准**:
  - 显示完整对话历史
  - 支持清空对话
  - 上下文自动携带（可配置上下文长度）

#### F-107 结果 JSON 结构化呈现
- **描述**: AI 返回结果使用 JSON 格式，明确区分优化前/优化后内容

> [!IMPORTANT]
> **可扩展性设计**：不同 Agent 处理的任务不同，返回的 JSON 格式可能不一样，因此展示样式也需要相应适配。前端需采用**可扩展的渲染架构**，便于后续新增 Agent 类型。

- **设计要求**:
  - 按 Agent 类型注册对应的 JSON Schema 和渲染器
  - 新增 Agent 时只需添加配置，无需修改核心渲染逻辑
  - 渲染器与业务逻辑解耦

- **JSON 结构示例** (以任务润色为例):
```json
{
  "type": "task_refine",
  "original": "原始任务名称",
  "optimized": "优化后的任务名称",
  "reasoning": "优化理由（可选，思考过程不展示）"
}
```

- **验收标准**:
  - 前端根据 `type` 字段动态选择渲染器
  - 仅展示核心字段（如 `original`、`optimized`）
  - `reasoning` 等附加信息折叠显示（可选展开）
  - 新增 Agent 类型时，开发成本低、改动范围小

#### F-108 优化结果应用/撤回
- **描述**: 用户可选择应用或撤回 AI 优化结果
- **验收标准**:
  - 提供"应用"和"撤回"按钮
  - 应用后更新原始数据
  - 撤回后恢复原始值
  - 操作后有明确反馈

---

### 2.4 提示词管理

| 需求编号 | 需求名称 | 优先级 | 依赖 |
|:--------:|:--------:|:------:|:----:|
| F-109 | 提示词部分可编辑 | P2 | - |
| F-110 | AI 重新调用 | P1 | - |

#### F-109 提示词部分可编辑
- **描述**: 用户可修改 Agent 的部分提示词内容，用户还是可以恢复为默认的提示词
- **设计约束**:
  - **可编辑区域**: 用户指令、语气偏好、输出长度等
  - **不可编辑区域**: 返回格式约束（如必须返回 JSON）、系统角色定义
- **验收标准**:
  - 可编辑部分以输入框形式展示
  - 不可编辑部分灰显或隐藏
  - 编辑后实时预览最终 Prompt（可选）
  - 提供"恢复默认"按钮，点击后恢复为默认的提示词

#### F-110 AI 重新调用
- **描述**: 提供"重新生成"按钮，使用相同输入重新调用 AI
- **验收标准**:
  - 按钮位于 AI 回复下方
  - 重新生成时显示加载状态
  - 新结果替换旧结果（或追加展示）

---

### 2.5 Token 透明化

| 需求编号 | 需求名称 | 优先级 | 依赖 |
|:--------:|:--------:|:------:|:----:|
| F-111 | Token 使用统计 | P1 | - |

#### F-111 Token 使用统计
- **描述**: 实时展示当前对话的 Token 使用情况
- **展示内容**:
  - 本次请求 Token 数（Prompt + Completion）
  - 会话累计 Token 数（可选）
- **验收标准**:
  - 在侧边栏底部或消息气泡旁展示
  - 数据来源于 API 响应的 `usage` 字段
  - 格式示例: `Tokens: 150 (输入: 50 / 输出: 100)`

---

### 2.6 任务编辑增强

| 需求编号 | 需求名称 | 优先级 | 依赖 |
|:--------:|:--------:|:------:|:----:|
| F-112 | 任务概述字段 | P1 | - |

#### F-112 任务概述字段
- **描述**: 在任务编辑页新增"任务概述"列，支持长文本录入
- **字段规格**:

| 字段名 | 类型 | 必填 | 说明 |
|:-------|:-----|:-----|:-----|
| 任务名称 | 短文本 | 是 | 简洁的任务标题 |
| 任务概述 | 长文本 | 否 | 详细的任务描述 |

- **验收标准**:
  - 任务概述支持多行输入（Textarea）
  - 在甘特图表格中以省略形式展示
  - 悬停或点击展开完整内容
  - 数据持久化至任务数据结构
  - 导入和导出功能也要相应调整，甘特图鼠标悬停展示信息中也需要加上任务概述等其他可能受影响的地方

---

## 3. 界面保留说明

> [!IMPORTANT]
> 根据变更要求，以下 UI 元素**暂时保留**，不做删除处理：
> - AI 设置按钮
> - 任务分解按钮

![当前 UI 状态](../root/image-1.png)

---

## 4. 优先级排序

| 优先级 | 需求编号 | 说明 |
|:------:|:---------|:-----|
| P0 | F-101, F-102, F-104, F-105, F-107, F-108 | 核心体验优化 |
| P1 | F-103, F-106, F-110, F-111, F-112 | 功能增强 |
| P2 | F-109 | 高级功能 |

---

## 5. 与历史需求关联

本需求是对 [PRD-AI-Agent-架构.md](./PRD-AI-Agent-架构.md) 的功能扩展和体验优化：

| 原始需求 | 优化需求 | 关联说明 |
|:---------|:---------|:---------|
| F-001 API 配置入口 | F-101, F-102, F-103 | 配置界面优化 |
| F-005 流式响应 | F-105, F-106 | 交互体验优化 |
| F-006 状态反馈 | F-104 | 错误处理增强 |
| F-004 预设智能体调用 | F-107, F-108, F-109, F-110 | Agent 交互增强 |
| - | F-111 | 新增 Token 透明化 |
| - | F-112 | 新增任务概述字段 |

---

## 6. 验收标准总览

1. 所有需求完成并通过测试
2. AI 配置流程顺畅，错误提示友好
3. AI 交互侧边栏符合现代产品设计规范
4. Token 使用清晰可见
5. 任务概述字段正常工作

---

## 附录: 变更追踪

| 版本 | 日期 | 变更内容 | 作者 |
|:-----|:-----|:---------|:-----|
| v2.0 | 2026-01-18 | 初始版本，基于变更记录整理 | Product Manager |
| v2.0.1 | 2026-01-18 | F-102 新增手动输入模式；F-107 强调可扩展架构设计；验收标准调整为全量测试 | Product Manager |

---

## 3. 用户反馈优化 (v2.1 增补)

> **更新日期**: 2026-01-18 (根据用户反馈调整)

| 需求编号 | 需求名称 | 优先级 | 描述 |
|:--------:|:--------:|:------:|:----|
| F-201 | 撤回功能增强 | P0 | 修复 AI 应用修改后的撤回问题，确保 Ctrl+Z 能完美回滚到修改前状态。 |
| F-202 | 会话管理优化 | P1 | 每次打开 AI 助手抽屉时，默认开启新会话（清空历史），不保留上次记录。 |
| F-203 | 界面交互精简 | P1 | 隐藏顶部工具栏的快捷指令按钮，保留 "AI 设置" 入口（或整合）。 |
| F-204 | 悬浮按钮位置 | P2 | 调整 AI 浮动按钮默认位置（上移），避免遮挡底部视图切换控件。 |

### 3.1 详细说明

#### F-201 撤回功能增强
- **现状**: 用户反馈 "撤回功能好像有问题"。
- **目标**: 确保 AI 修改操作（如 `task.text = newText`）被正确封装在 Gantt 的事务/Undo 栈中。
- **验证**: 应用修改 -> 任务变更有记录 -> 按 Ctrl+Z -> 任务恢复原状。

#### F-202 会话管理优化
- **现状**: 关闭抽屉再打开，历史记录仍在。
- **目标**: 下次打开时，自动重置 `conversationHistory`，不带入上次状态。

#### F-203 界面交互精简
- **现状**: 界面上存在多个 AI 快捷按钮。
- **目标**:
  - 只保留 "AI 设置" 入口。
  - 其他快捷指令入口暂时隐藏。
  - 浮动按钮点击直接进入对话界面（通用助手模式）。

#### F-204 悬浮按钮位置调整
- **现状**: 紫色悬浮按钮遮挡了右下角的视图切换组件。
- **目标**: 调高 `bottom` 属性，使其默认位于视图切换组件上方。
