# 需求文档 (Product Requirements Document)

## 1. 概述
- **名称**：下一代甘特图编辑器改进计划 (Gantt Editor Evolution v1.0)
- **定位**：基于现有 vanilla JS + DHTMLX 架构，通过核心交互优化与智能调度引擎，打造高性能、易用的项目管理工具。
- **目标用户**：项目经理 (关注排程与依赖)、团队成员 (关注移动端任务查看与简单更新)。
- **核心问题**：解决大项目渲染卡顿 ("性能瓶颈")、手动调整排程繁琐 ("规划炼狱") 以及移动端体验缺失的问题。

## 2. 核心改进分析 (PM & FE 联合评估)

基于《竞品分析报告》与当前技术栈 (`Vanilla JS` + `DHTMLX Gantt CDN`) 的深度评估：

| 竞品建议特性 | PM 价值评估 | FE 技术可行性评估 | 最终决策 |
| :--- | :--- | :--- | :--- |
| **Virtual Scrolling (React)** | 高 (解决卡顿) | **修正**：当前非 React 项目。应启用 DHTMLX 内置 `smart_rendering`。 | 🟢 采用 DHTMLX 智能渲染 |
| **Auto-Scheduling (自动调度)** | 极高 (核心痛点) | 可行。需实现基于 DAG 的递归更新逻辑 (Vanilla JS)。 | 🟢 P0 级需求 |
| **Mobile App / View** | 高 (现场协作) | 高。通过 CSS Media Queries 隐藏 Gantt图表，仅展示 Task List。 | 🟢 采用响应式视图降级 |
| **Critical Path (CPM)** | 中 (专业功能) | **风险**：DHTMLX GPL 版可能不含 CPM 插件。需手写 JS 算法实现正/逆向推导。 | 🟡 P1 级需求 (自定义实现) |
| **React Native / Component** | 低 (架构重构成本大) | **否决**：保持现有原生架构，避免重写成本。 | 🔴 维持现有架构 |

## 3. 详细需求清单

### 3.1 性能优化 (Performance) - P0
- **目标**：支持 1000+ 任务流畅滚动与拖拽。
- **功能要求**：
    1.  **智能渲染**: 启用 `gantt.config.smart_rendering = true`，仅渲染视口内的 DOM 元素。
    2.  **防抖处理**: 拖拽任务时仅更新 Ghost 元素，通过 `onAfterTaskDrag` 统一触发重绘与计算。
    3.  **DOM 复用**: 优化 Grid 行的渲染逻辑，减少重排 (Reflow)。

### 3.2 智能调度引擎 (Auto-Scheduling) - P0
- **目标**：任务变动时，自动维护依赖关系和时间逻辑的正确性。
- **功能要求**：
    1.  **级联更新**: 当任务 A 结束时间变更，且存在 `A -> B` 依赖时，自动推迟 B 的开始时间。
    2.  **工作日历 (Work Calendar)**: 启用 `work_time` 配置，自动跳过周末和非工作时间进行排程计算（精确到天）。
    3.  **父任务自动聚合 (WBS Calculation)**: 父任务的开始/结束时间应自动由其所有子任务的最早开始时间和最晚结束时间决定，禁止直接手动修改父任务时间。
    4.  **扩展依赖类型**:
        -   完善 FS (Finish-to-Start) 逻辑。
        -   **新增** 支持 SS (Start-to-Start) 依赖：任务 B 必须在任务 A 开始后才能开始（可配合 Lag 使用）。
    5.  **循环检测**: 建立依赖关系时，运行 DFS 算法检测是否存在环路，若存在则阻止并提示错误。
    6.  **Buffer/Lag 支持**: (P1) 支持设置延后时间 (e.g., A 结束后 2 天 B 开始)。

### 3.3 移动端适配 (Mobile Responsive) - P0
- **目标**：在手机端提供可用的任务查看与更新体验。
- **功能要求**：
    1.  **视口断点**: `< 768px` 时触发移动端模式。
    2.  **视图降级**: 隐藏右侧甘特图时间轴 (`display: none`)，全宽显示左侧 Grid。
    3.  **卡片式布局**: 移动端 Grid 样式调整为卡片流 (Task Name, Status, Date) 以适应触控。
    4.  **只读/轻交互**: 移动端禁用拖拽排程，仅支持点击状态切换或文本编辑。

### 3.4 交互体验优化 (UX Improvements) - P1
- **目标**：对标 Modern SaaS (Linear/Asana) 的操作手感。
- **功能要求**：
    1.  **内联编辑**: 双击 Grid 单元格直接进入编辑模式 (Input/DatePicker)，替代全屏弹窗。
    2.  **连线交互**: 优化依赖连线的创建体验 (拖拽端点而非填写 ID)。
    3.  **关键路径高亮**: 手动实现 CPM 算法，计算 Float = 0 的任务，并提供 "显示关键路径" 开关 (CSS 高亮)。

## 4. 用户故事 (User Stories)

### P0 核心功能
*   **作为项目经理**，我希望拖拽一个前置任务延期时，所有后继任务自动顺延，且自动跳过周末，以便排程符合真实工作日历。
*   **作为项目经理**，我希望能设置"并行任务" (SS 关系)，例如前端开发开始后 2 天后端就可以开始介入，而不需要等前端完全结束。
*   **作为开发人员**，我希望打开包含 500 个任务的项目时页面不卡顿，以便我能流畅地进行滚动和查看。
*   **作为现场执行人员**，我希望在手机上能清晰看到今天的任务列表，而不是一个缩成一团的甘特图，以便我快速确认工作内容。

### P1 进阶功能
*   **作为项目经理**，我希望一眼看到哪些任务是"关键路径" (不可延期)，以便我集中资源管理风险。
*   **作为用户**，我希望双击任务名就能直接修改，而不是每次都弹窗，以便我快速进行批量调整。

## 5. 技术约束 (Constraints)
- **架构**: 必须维持 `Vanilla JS` + `Vite` + `DHTMLX CDN` 架构，不引入 React/Vue 框架。
- **兼容性**: DHTMLX GPL 版限制 (无付费插件支持)，高级算法需自行通过 JS 实现。
- **浏览器**: 主流现代浏览器 (Chrome/Edge/Safari)，移动端适配于 iOS Safari/Android Chrome。

## 6. 验收标准
1.  **性能**: 生成 1000 个任务的 Mock 数据，FPS 保持在 50 以上。
2.  **自动化**: (FS/SS) 依赖变动时，后继任务自动更新，且**跳过周六日**。
3.  **以父带子**: 拖拽子任务超出父任务范围时，父任务时间自动撑大；缩短子任务时，父任务自动收缩。
4.  **移动端**: 手机访问时自动隐藏 TimeLine，Grid 正常显示且无横向滚动条。
